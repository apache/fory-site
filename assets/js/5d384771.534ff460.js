"use strict";(self.webpackChunkfory_site=self.webpackChunkfory_site||[]).push([[9633],{17627:(e,r,i)=>{i.r(r),i.d(r,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>s,metadata:()=>a,toc:()=>o});var n=i(85893),t=i(11151);const s={title:"Custom Serializers",sidebar_position:35,id:"custom_serializers",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},l=void 0,a={id:"guide/go/custom_serializers",title:"Custom Serializers",description:"Custom serializers allow you to define exactly how a type is serialized and deserialized. This is useful for types that require special handling, optimization, or cross-language compatibility.",source:"@site/versioned_docs/version-0.15/guide/go/custom-serializers.md",sourceDirName:"guide/go",slug:"/guide/go/custom_serializers",permalink:"/docs/guide/go/custom_serializers",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/fory-site/tree/main/docs/guide/go/custom-serializers.md",tags:[],version:"0.15",sidebarPosition:35,frontMatter:{title:"Custom Serializers",sidebar_position:35,id:"custom_serializers",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},sidebar:"docsSidebar",previous:{title:"Type Registration",permalink:"/docs/guide/go/type_registration"},next:{title:"Supported Types",permalink:"/docs/guide/go/supported_types"}},d={},o=[{value:"When to Use Custom Serializers",id:"when-to-use-custom-serializers",level:2},{value:"ExtensionSerializer Interface",id:"extensionserializer-interface",level:2},{value:"Basic Example",id:"basic-example",level:2},{value:"Context Methods",id:"context-methods",level:2},{value:"ByteBuffer Methods",id:"bytebuffer-methods",level:2},{value:"Writing Methods",id:"writing-methods",level:3},{value:"Reading Methods",id:"reading-methods",level:3},{value:"Complex Type Example",id:"complex-type-example",level:2},{value:"Handling Pointers",id:"handling-pointers",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Registration Options",id:"registration-options",level:2},{value:"Register by ID",id:"register-by-id",level:3},{value:"Register by Name",id:"register-by-name",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Testing Custom Serializers",id:"testing-custom-serializers",level:2},{value:"Related Topics",id:"related-topics",level:2}];function c(e){const r={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.p,{children:"Custom serializers allow you to define exactly how a type is serialized and deserialized. This is useful for types that require special handling, optimization, or cross-language compatibility."}),"\n",(0,n.jsx)(r.h2,{id:"when-to-use-custom-serializers",children:"When to Use Custom Serializers"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Special encoding"}),": Types that need a specific binary format"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Third-party types"}),": Types from external libraries that Fory doesn't handle automatically"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Optimization"}),": When you can serialize more efficiently than the default reflection-based approach"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Cross-language compatibility"}),": When you need precise control over the binary format for interoperability"]}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"extensionserializer-interface",children:"ExtensionSerializer Interface"}),"\n",(0,n.jsxs)(r.p,{children:["Custom serializers implement the ",(0,n.jsx)(r.code,{children:"ExtensionSerializer"})," interface:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:"type ExtensionSerializer interface {\n    // WriteData serializes the value to the buffer.\n    // Only write the data - Fory handles type info and references.\n    // Use ctx.Buffer() to access the ByteBuffer.\n    // Use ctx.SetError() to report errors.\n    WriteData(ctx *WriteContext, value reflect.Value)\n\n    // ReadData deserializes the value from the buffer into the provided value.\n    // Only read the data - Fory handles type info and references.\n    // Use ctx.Buffer() to access the ByteBuffer.\n    // Use ctx.SetError() to report errors.\n    ReadData(ctx *ReadContext, value reflect.Value)\n}\n"})}),"\n",(0,n.jsx)(r.h2,{id:"basic-example",children:"Basic Example"}),"\n",(0,n.jsx)(r.p,{children:"Here's a simple custom serializer for a type with an integer field:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:'import (\n    "reflect"\n    "github.com/apache/fory/go/fory"\n)\n\ntype MyExt struct {\n    Id int32\n}\n\ntype MyExtSerializer struct{}\n\nfunc (s *MyExtSerializer) WriteData(ctx *fory.WriteContext, value reflect.Value) {\n    myExt := value.Interface().(MyExt)\n    ctx.Buffer().WriteVarint32(myExt.Id)\n}\n\nfunc (s *MyExtSerializer) ReadData(ctx *fory.ReadContext, value reflect.Value) {\n    id := ctx.Buffer().ReadVarint32(ctx.Err())\n    value.Set(reflect.ValueOf(MyExt{Id: id}))\n}\n\n// Register the custom serializer\nf := fory.New()\nerr := f.RegisterExtension(MyExt{}, 100, &MyExtSerializer{})\n'})}),"\n",(0,n.jsx)(r.h2,{id:"context-methods",children:"Context Methods"}),"\n",(0,n.jsxs)(r.p,{children:["The ",(0,n.jsx)(r.code,{children:"WriteContext"})," and ",(0,n.jsx)(r.code,{children:"ReadContext"})," provide access to serialization resources:"]}),"\n",(0,n.jsxs)(r.table,{children:[(0,n.jsx)(r.thead,{children:(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.th,{children:"Method"}),(0,n.jsx)(r.th,{children:"Description"})]})}),(0,n.jsxs)(r.tbody,{children:[(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"Buffer()"})}),(0,n.jsxs)(r.td,{children:["Returns the ",(0,n.jsx)(r.code,{children:"*ByteBuffer"})," for reading/writing"]})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"Err()"})}),(0,n.jsxs)(r.td,{children:["Returns ",(0,n.jsx)(r.code,{children:"*Error"})," for deferred error checking"]})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"SetError(err)"})}),(0,n.jsx)(r.td,{children:"Sets an error on the context"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"HasError()"})}),(0,n.jsx)(r.td,{children:"Returns true if an error has been set"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"TypeResolver()"})}),(0,n.jsx)(r.td,{children:"Returns the type resolver for nested types"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"RefResolver()"})}),(0,n.jsx)(r.td,{children:"Returns the reference resolver for ref support"})]})]})]}),"\n",(0,n.jsx)(r.h2,{id:"bytebuffer-methods",children:"ByteBuffer Methods"}),"\n",(0,n.jsxs)(r.p,{children:["The ",(0,n.jsx)(r.code,{children:"ByteBuffer"})," provides methods for reading and writing primitive types:"]}),"\n",(0,n.jsx)(r.h3,{id:"writing-methods",children:"Writing Methods"}),"\n",(0,n.jsxs)(r.table,{children:[(0,n.jsx)(r.thead,{children:(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.th,{children:"Method"}),(0,n.jsx)(r.th,{children:"Description"})]})}),(0,n.jsxs)(r.tbody,{children:[(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteBool(v bool)"})}),(0,n.jsx)(r.td,{children:"Write a boolean"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteInt8(v int8)"})}),(0,n.jsx)(r.td,{children:"Write a signed 8-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteInt16(v int16)"})}),(0,n.jsx)(r.td,{children:"Write a signed 16-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteInt32(v int32)"})}),(0,n.jsx)(r.td,{children:"Write a signed 32-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteInt64(v int64)"})}),(0,n.jsx)(r.td,{children:"Write a signed 64-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteFloat32(v float32)"})}),(0,n.jsx)(r.td,{children:"Write a 32-bit float"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteFloat64(v float64)"})}),(0,n.jsx)(r.td,{children:"Write a 64-bit float"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteVarint32(v int32)"})}),(0,n.jsx)(r.td,{children:"Write a variable-length signed 32-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteVarint64(v int64)"})}),(0,n.jsx)(r.td,{children:"Write a variable-length signed 64-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"WriteBinary(data []byte)"})}),(0,n.jsx)(r.td,{children:"Write raw bytes"})]})]})]}),"\n",(0,n.jsx)(r.h3,{id:"reading-methods",children:"Reading Methods"}),"\n",(0,n.jsxs)(r.p,{children:["All read methods take an ",(0,n.jsx)(r.code,{children:"*Error"})," parameter for deferred error checking:"]}),"\n",(0,n.jsxs)(r.table,{children:[(0,n.jsx)(r.thead,{children:(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.th,{children:"Method"}),(0,n.jsx)(r.th,{children:"Description"})]})}),(0,n.jsxs)(r.tbody,{children:[(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadBool(err *Error) bool"})}),(0,n.jsx)(r.td,{children:"Read a boolean"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadInt8(err *Error) int8"})}),(0,n.jsx)(r.td,{children:"Read a signed 8-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadInt16(err *Error) int16"})}),(0,n.jsx)(r.td,{children:"Read a signed 16-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadInt32(err *Error) int32"})}),(0,n.jsx)(r.td,{children:"Read a signed 32-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadInt64(err *Error) int64"})}),(0,n.jsx)(r.td,{children:"Read a signed 64-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadFloat32(err *Error) float32"})}),(0,n.jsx)(r.td,{children:"Read a 32-bit float"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadFloat64(err *Error) float64"})}),(0,n.jsx)(r.td,{children:"Read a 64-bit float"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadVarint32(err *Error) int32"})}),(0,n.jsx)(r.td,{children:"Read a variable-length signed 32-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadVarint64(err *Error) int64"})}),(0,n.jsx)(r.td,{children:"Read a variable-length signed 64-bit integer"})]}),(0,n.jsxs)(r.tr,{children:[(0,n.jsx)(r.td,{children:(0,n.jsx)(r.code,{children:"ReadBinary(length int, err *Error) []byte"})}),(0,n.jsx)(r.td,{children:"Read raw bytes of specified length"})]})]})]}),"\n",(0,n.jsx)(r.h2,{id:"complex-type-example",children:"Complex Type Example"}),"\n",(0,n.jsx)(r.p,{children:"A custom serializer for a type with multiple fields:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:"type Point3D struct {\n    X, Y, Z float64\n    Label   string\n}\n\ntype Point3DSerializer struct{}\n\nfunc (s *Point3DSerializer) WriteData(ctx *fory.WriteContext, value reflect.Value) {\n    p := value.Interface().(Point3D)\n    buf := ctx.Buffer()\n    buf.WriteFloat64(p.X)\n    buf.WriteFloat64(p.Y)\n    buf.WriteFloat64(p.Z)\n    // Write string as length + bytes\n    labelBytes := []byte(p.Label)\n    buf.WriteVarint32(int32(len(labelBytes)))\n    buf.WriteBinary(labelBytes)\n}\n\nfunc (s *Point3DSerializer) ReadData(ctx *fory.ReadContext, value reflect.Value) {\n    buf := ctx.Buffer()\n    err := ctx.Err()\n    x := buf.ReadFloat64(err)\n    y := buf.ReadFloat64(err)\n    z := buf.ReadFloat64(err)\n    labelLen := buf.ReadVarint32(err)\n    labelBytes := buf.ReadBinary(int(labelLen), err)\n    value.Set(reflect.ValueOf(Point3D{\n        X:     x,\n        Y:     y,\n        Z:     z,\n        Label: string(labelBytes),\n    }))\n}\n\nf := fory.New()\nf.RegisterExtension(Point3D{}, 101, &Point3DSerializer{})\n"})}),"\n",(0,n.jsx)(r.h2,{id:"handling-pointers",children:"Handling Pointers"}),"\n",(0,n.jsx)(r.p,{children:"When your type contains pointers, handle nil values explicitly:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:"type OptionalValue struct {\n    Value *int64\n}\n\ntype OptionalValueSerializer struct{}\n\nfunc (s *OptionalValueSerializer) WriteData(ctx *fory.WriteContext, value reflect.Value) {\n    ov := value.Interface().(OptionalValue)\n    buf := ctx.Buffer()\n    if ov.Value == nil {\n        buf.WriteBool(false) // nil flag\n    } else {\n        buf.WriteBool(true) // not nil\n        buf.WriteInt64(*ov.Value)\n    }\n}\n\nfunc (s *OptionalValueSerializer) ReadData(ctx *fory.ReadContext, value reflect.Value) {\n    buf := ctx.Buffer()\n    err := ctx.Err()\n    hasValue := buf.ReadBool(err)\n    if !hasValue {\n        value.Set(reflect.ValueOf(OptionalValue{Value: nil}))\n        return\n    }\n    v := buf.ReadInt64(err)\n    value.Set(reflect.ValueOf(OptionalValue{Value: &v}))\n}\n"})}),"\n",(0,n.jsx)(r.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,n.jsxs)(r.p,{children:["Use ",(0,n.jsx)(r.code,{children:"ctx.SetError()"})," to report errors:"]}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:'func (s *MySerializer) ReadData(ctx *fory.ReadContext, value reflect.Value) {\n    buf := ctx.Buffer()\n    version := buf.ReadInt8(ctx.Err())\n    if ctx.HasError() {\n        return\n    }\n    if version != 1 {\n        ctx.SetError(fory.DeserializationErrorf("unsupported version: %d", version))\n        return\n    }\n    // Continue reading...\n    value.Set(reflect.ValueOf(result))\n}\n'})}),"\n",(0,n.jsx)(r.h2,{id:"registration-options",children:"Registration Options"}),"\n",(0,n.jsx)(r.h3,{id:"register-by-id",children:"Register by ID"}),"\n",(0,n.jsx)(r.p,{children:"More compact serialization, requires ID coordination across languages:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:"f.RegisterExtension(MyType{}, 100, &MySerializer{})\n"})}),"\n",(0,n.jsx)(r.h3,{id:"register-by-name",children:"Register by Name"}),"\n",(0,n.jsx)(r.p,{children:"More flexible but more serialization cost, type name included in serialized data:"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:'f.RegisterNamedExtension(MyType{}, "myapp.MyType", &MySerializer{})\n'})}),"\n",(0,n.jsx)(r.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,n.jsxs)(r.ol,{children:["\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Keep it simple"}),": Only serialize what you need"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Use variable-length integers"}),": ",(0,n.jsx)(r.code,{children:"WriteVarint32"}),"/",(0,n.jsx)(r.code,{children:"WriteVarint64"})," for integers that are often small"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Handle nil explicitly"}),": Check for nil pointers and slices"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Version your format"}),": Consider adding a version byte for future compatibility"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Test round-trips"}),": Always verify that ",(0,n.jsx)(r.code,{children:"Read(Write(value)) == value"})]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Match read/write order"}),": Read fields in exactly the same order you write them"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Check errors"}),": Use ",(0,n.jsx)(r.code,{children:"ctx.HasError()"})," after reading to handle errors gracefully"]}),"\n",(0,n.jsxs)(r.li,{children:[(0,n.jsx)(r.strong,{children:"Deploy before use"}),": Always deploy the registered serializer to all services before sending data serialized with it. If a service receives data for an unregistered serializer, deserialization will fail"]}),"\n"]}),"\n",(0,n.jsx)(r.h2,{id:"testing-custom-serializers",children:"Testing Custom Serializers"}),"\n",(0,n.jsx)(r.pre,{children:(0,n.jsx)(r.code,{className:"language-go",children:'func TestMySerializer(t *testing.T) {\n    f := fory.New()\n    f.RegisterExtension(MyType{}, 100, &MySerializer{})\n\n    original := MyType{Field: "test"}\n\n    // Serialize\n    data, err := f.Serialize(original)\n    require.NoError(t, err)\n\n    // Deserialize\n    var result MyType\n    err = f.Deserialize(data, &result)\n    require.NoError(t, err)\n\n    assert.Equal(t, original, result)\n}\n'})}),"\n",(0,n.jsx)(r.h2,{id:"related-topics",children:"Related Topics"}),"\n",(0,n.jsxs)(r.ul,{children:["\n",(0,n.jsx)(r.li,{children:(0,n.jsx)(r.a,{href:"/docs/guide/go/type_registration",children:"Type Registration"})}),"\n",(0,n.jsx)(r.li,{children:(0,n.jsx)(r.a,{href:"/docs/guide/go/supported_types",children:"Supported Types"})}),"\n",(0,n.jsx)(r.li,{children:(0,n.jsx)(r.a,{href:"/docs/guide/go/cross_language",children:"Cross-Language Serialization"})}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,t.a)(),...e.components};return r?(0,n.jsx)(r,{...e,children:(0,n.jsx)(c,{...e})}):c(e)}},11151:(e,r,i)=>{i.d(r,{Z:()=>a,a:()=>l});var n=i(67294);const t={},s=n.createContext(t);function l(e){const r=n.useContext(s);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),n.createElement(s.Provider,{value:r},e.children)}}}]);