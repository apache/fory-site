"use strict";(self.webpackChunkfory_site=self.webpackChunkfory_site||[]).push([[95371],{83015:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>o,toc:()=>c});var t=i(85893),s=i(11151);const a={title:"Schema Evolution",sidebar_position:5,id:"schema_evolution",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},r=void 0,o={id:"guide/java/schema_evolution",title:"Schema Evolution",description:"This page covers schema evolution, meta sharing, and handling non-existent/unknown classes.",source:"@site/versioned_docs/version-0.15/guide/java/schema-evolution.md",sourceDirName:"guide/java",slug:"/guide/java/schema_evolution",permalink:"/docs/guide/java/schema_evolution",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/fory-site/tree/main/docs/guide/java/schema-evolution.md",tags:[],version:"0.15",sidebarPosition:5,frontMatter:{title:"Schema Evolution",sidebar_position:5,id:"schema_evolution",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},sidebar:"docsSidebar",previous:{title:"Field Configuration",permalink:"/docs/guide/java/field_configuration"},next:{title:"Compression",permalink:"/docs/guide/java/compression"}},l={},c=[{value:"Handling Class Schema Evolution",id:"handling-class-schema-evolution",level:2},{value:"Default Mode: SCHEMA_CONSISTENT",id:"default-mode-schema_consistent",level:3},{value:"Compatible Mode",id:"compatible-mode",level:3},{value:"Disable Evolution for Stable Classes",id:"disable-evolution-for-stable-classes",level:3},{value:"Meta Sharing",id:"meta-sharing",level:2},{value:"Using Meta Sharing",id:"using-meta-sharing",level:3},{value:"Thread-Safe Meta Sharing",id:"thread-safe-meta-sharing",level:3},{value:"Deserialize Unknown Classes",id:"deserialize-unknown-classes",level:2},{value:"Copy/Map Object from One Type to Another",id:"copymap-object-from-one-type-to-another",level:2},{value:"Deserialize POJO into Another Type",id:"deserialize-pojo-into-another-type",level:2},{value:"Configuration Options",id:"configuration-options",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Related Topics",id:"related-topics",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"This page covers schema evolution, meta sharing, and handling non-existent/unknown classes."}),"\n",(0,t.jsx)(n.h2,{id:"handling-class-schema-evolution",children:"Handling Class Schema Evolution"}),"\n",(0,t.jsx)(n.p,{children:"In many systems, the schema of a class used for serialization may change over time. For instance, fields within a class may be added or removed. When serialization and deserialization processes use different versions of jars, the schema of the class being deserialized may differ from the one used during serialization."}),"\n",(0,t.jsx)(n.h3,{id:"default-mode-schema_consistent",children:"Default Mode: SCHEMA_CONSISTENT"}),"\n",(0,t.jsxs)(n.p,{children:["By default, Fory serializes objects using the ",(0,t.jsx)(n.code,{children:"CompatibleMode.SCHEMA_CONSISTENT"})," mode. This mode assumes that the deserialization process uses the same class schema as the serialization process, minimizing payload overhead. However, if there is a schema inconsistency, deserialization will fail."]}),"\n",(0,t.jsx)(n.h3,{id:"compatible-mode",children:"Compatible Mode"}),"\n",(0,t.jsxs)(n.p,{children:["If the schema is expected to change, to make deserialization succeed (i.e., schema forward/backward compatibility), users must configure Fory to use ",(0,t.jsx)(n.code,{children:"CompatibleMode.COMPATIBLE"}),". This can be done using the ",(0,t.jsx)(n.code,{children:"ForyBuilder#withCompatibleMode(CompatibleMode.COMPATIBLE)"})," method."]}),"\n",(0,t.jsx)(n.p,{children:"In this compatible mode, deserialization can handle schema changes such as missing or extra fields, allowing it to succeed even when the serialization and deserialization processes have different class schemas."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"Fory fory = Fory.builder()\n  .withCompatibleMode(CompatibleMode.COMPATIBLE)\n  .build();\n\nbyte[] bytes = fory.serialize(object);\nSystem.out.println(fory.deserialize(bytes));\n"})}),"\n",(0,t.jsx)(n.p,{children:"This compatible mode involves serializing class metadata into the serialized output. Despite Fory's use of sophisticated compression techniques to minimize overhead, there is still some additional space cost associated with class metadata."}),"\n",(0,t.jsx)(n.h3,{id:"disable-evolution-for-stable-classes",children:"Disable Evolution for Stable Classes"}),"\n",(0,t.jsxs)(n.p,{children:["If a class schema is stable and will not change, you can opt out of schema evolution on a per-class basis to avoid compatible metadata overhead. Annotate the class with ",(0,t.jsx)(n.code,{children:"@ForyObject(evolving = false)"})," to force ",(0,t.jsx)(n.code,{children:"STRUCT/NAMED_STRUCT"})," type IDs even when Compatible mode is enabled."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"import org.apache.fory.annotation.ForyObject;\n\n@ForyObject(evolving = false)\npublic class StableMessage {\n  public int id;\n  public String name;\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"meta-sharing",children:"Meta Sharing"}),"\n",(0,t.jsx)(n.p,{children:"To further reduce metadata costs, Fory introduces a class metadata sharing mechanism, which allows the metadata to be sent to the deserialization process only once."}),"\n",(0,t.jsx)(n.p,{children:"Fory supports sharing type metadata (class name, field name, final field type information, etc.) between multiple serializations in a context (ex. TCP connection). This information will be sent to the peer during the first serialization in the context. Based on this metadata, the peer can rebuild the same deserializer, which avoids transmitting metadata for subsequent serializations and reduces network traffic pressure while supporting type forward/backward compatibility automatically."}),"\n",(0,t.jsx)(n.h3,{id:"using-meta-sharing",children:"Using Meta Sharing"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// Fory.builder()\n//   .withLanguage(Language.JAVA)\n//   .withRefTracking(false)\n//   // share meta across serialization.\n//   .withMetaShare(true)\n\n// Not thread-safe fory.\nMetaContext context = xxx;\nfory.getSerializationContext().setMetaContext(context);\nbyte[] bytes = fory.serialize(o);\n\n// Not thread-safe fory.\nMetaContext context = xxx;\nfory.getSerializationContext().setMetaContext(context);\nfory.deserialize(bytes);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"thread-safe-meta-sharing",children:"Thread-Safe Meta Sharing"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// Thread-safe fory\nfory.setClassLoader(beanA.getClass().getClassLoader());\nbyte[] serialized = fory.execute(\n  f -> {\n    f.getSerializationContext().setMetaContext(context);\n    return f.serialize(beanA);\n  }\n);\n\n// Thread-safe fory\nfory.setClassLoader(beanA.getClass().getClassLoader());\nObject newObj = fory.execute(\n  f -> {\n    f.getSerializationContext().setMetaContext(context);\n    return f.deserialize(serialized);\n  }\n);\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Note"}),": ",(0,t.jsx)(n.code,{children:"MetaContext"})," is not thread-safe and cannot be reused across instances of Fory or multiple threads. In cases of multi-threading, a separate ",(0,t.jsx)(n.code,{children:"MetaContext"})," must be created for each Fory instance."]}),"\n",(0,t.jsxs)(n.p,{children:["For more details, please refer to the ",(0,t.jsx)(n.a,{href:"https://fory.apache.org/docs/specification/fory_java_serialization_spec#meta-share",children:"Meta Sharing specification"}),"."]}),"\n",(0,t.jsx)(n.h2,{id:"deserialize-unknown-classes",children:"Deserialize Unknown Classes"}),"\n",(0,t.jsxs)(n.p,{children:["Fory supports deserializing non-existent or unknown classes. This feature can be enabled by ",(0,t.jsx)(n.code,{children:"ForyBuilder#deserializeUnknownClass(true)"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"When enabled and metadata sharing is enabled, Fory will store the deserialized data of this type in a lazy subclass of Map. By using the lazy map implemented by Fory, the rebalance cost of filling map during deserialization can be avoided, which further improves performance."}),"\n",(0,t.jsx)(n.p,{children:"If this data is sent to another process and the class exists in this process, the data will be deserialized into the object of this type without losing any information."}),"\n",(0,t.jsxs)(n.p,{children:["If metadata sharing is not enabled, the new class data will be skipped and a ",(0,t.jsx)(n.code,{children:"UnknownSkipClass"})," stub object will be returned."]}),"\n",(0,t.jsx)(n.h2,{id:"copymap-object-from-one-type-to-another",children:"Copy/Map Object from One Type to Another"}),"\n",(0,t.jsx)(n.p,{children:"Fory supports mapping objects from one type to another type."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Notes:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"This mapping will execute a deep copy. All mapped fields are serialized into binary and deserialized from that binary to map into another type."}),"\n",(0,t.jsxs)(n.li,{children:["All struct types must be registered with the same ID, otherwise Fory cannot map to the correct struct type. Be careful when you use ",(0,t.jsx)(n.code,{children:"Fory#register(Class)"}),", because Fory will allocate an auto-grown ID which might be inconsistent if you register classes with different order between Fory instances."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public class StructMappingExample {\n  static class Struct1 {\n    int f1;\n    String f2;\n\n    public Struct1(int f1, String f2) {\n      this.f1 = f1;\n      this.f2 = f2;\n    }\n  }\n\n  static class Struct2 {\n    int f1;\n    String f2;\n    double f3;\n  }\n\n  static ThreadSafeFory fory1 = Fory.builder()\n    .withCompatibleMode(CompatibleMode.COMPATIBLE).buildThreadSafeFory();\n  static ThreadSafeFory fory2 = Fory.builder()\n    .withCompatibleMode(CompatibleMode.COMPATIBLE).buildThreadSafeFory();\n\n  static {\n    fory1.register(Struct1.class);\n    fory2.register(Struct2.class);\n  }\n\n  public static void main(String[] args) {\n    Struct1 struct1 = new Struct1(10, "abc");\n    Struct2 struct2 = (Struct2) fory2.deserialize(fory1.serialize(struct1));\n    Assert.assertEquals(struct2.f1, struct1.f1);\n    Assert.assertEquals(struct2.f2, struct1.f2);\n    struct1 = (Struct1) fory1.deserialize(fory2.serialize(struct2));\n    Assert.assertEquals(struct1.f1, struct2.f1);\n    Assert.assertEquals(struct1.f2, struct2.f2);\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"deserialize-pojo-into-another-type",children:"Deserialize POJO into Another Type"}),"\n",(0,t.jsxs)(n.p,{children:["Fory allows you to serialize one POJO and deserialize it into a different POJO. The different POJO means schema inconsistency. Users must configure Fory with ",(0,t.jsx)(n.code,{children:"CompatibleMode"})," set to ",(0,t.jsx)(n.code,{children:"org.apache.fory.config.CompatibleMode.COMPATIBLE"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public class DeserializeIntoType {\n  static class Struct1 {\n    int f1;\n    String f2;\n\n    public Struct1(int f1, String f2) {\n      this.f1 = f1;\n      this.f2 = f2;\n    }\n  }\n\n  static class Struct2 {\n    int f1;\n    String f2;\n    double f3;\n  }\n\n  static ThreadSafeFory fory = Fory.builder()\n    .withCompatibleMode(CompatibleMode.COMPATIBLE).buildThreadSafeFory();\n\n  public static void main(String[] args) {\n    Struct1 struct1 = new Struct1(10, "abc");\n    byte[] data = fory.serializeJavaObject(struct1);\n    Struct2 struct2 = (Struct2) fory.deserializeJavaObject(bytes, Struct2.class);\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"configuration-options",children:"Configuration Options"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Option"}),(0,t.jsx)(n.th,{children:"Description"}),(0,t.jsx)(n.th,{children:"Default"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"compatibleMode"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"SCHEMA_CONSISTENT"})," or ",(0,t.jsx)(n.code,{children:"COMPATIBLE"})]}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"SCHEMA_CONSISTENT"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"checkClassVersion"})}),(0,t.jsx)(n.td,{children:"Check class schema consistency"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"false"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"metaShareEnabled"})}),(0,t.jsx)(n.td,{children:"Enable meta sharing"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"true"})," if Compatible mode"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"scopedMetaShareEnabled"})}),(0,t.jsx)(n.td,{children:"Scoped meta share per serialization"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"true"})," if Compatible mode"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"deserializeUnknownClass"})}),(0,t.jsx)(n.td,{children:"Handle non-existent or unknown classes"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"true"})," if Compatible mode"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"metaCompressor"})}),(0,t.jsx)(n.td,{children:"Compressor for meta compression"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DeflaterMetaCompressor"})})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Use COMPATIBLE mode for evolving schemas"}),": When classes may change between versions"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Enable meta sharing for network communication"}),": Reduces bandwidth for repeated serializations"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Use consistent type IDs for struct mapping"}),": Ensure same registration order or explicit IDs"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Consider space overhead"}),": Compatible mode adds metadata, balance with your requirements"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"related-topics",children:"Related Topics"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/guide/java/configuration",children:"Configuration Options"})," - All ForyBuilder options"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/guide/java/cross_language",children:"Cross-Language Serialization"})," - XLANG mode"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/docs/guide/java/troubleshooting",children:"Troubleshooting"})," - Common schema issues"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},11151:(e,n,i)=>{i.d(n,{Z:()=>o,a:()=>r});var t=i(67294);const s={},a=t.createContext(s);function r(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);