"use strict";(self.webpackChunkfory_site=self.webpackChunkfory_site||[]).push([[54053],{22394:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>s,default:()=>h,frontMatter:()=>t,metadata:()=>o,toc:()=>l});var a=r(85893),i=r(11151);const t={title:"Thread Safety",sidebar_position:100,id:"thread_safety",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},s=void 0,o={id:"guide/go/thread_safety",title:"Thread Safety",description:"This guide covers concurrent usage patterns for Fory Go, including the thread-safe wrapper and best practices for multi-goroutine environments.",source:"@site/docs/guide/go/thread-safety.md",sourceDirName:"guide/go",slug:"/guide/go/thread_safety",permalink:"/docs/next/guide/go/thread_safety",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/fory-site/tree/main/docs/guide/go/thread-safety.md",tags:[],version:"current",sidebarPosition:100,frontMatter:{title:"Thread Safety",sidebar_position:100,id:"thread_safety",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},sidebar:"docsSidebar",previous:{title:"Code Generation",permalink:"/docs/next/guide/go/codegen"},next:{title:"Troubleshooting",permalink:"/docs/next/guide/go/troubleshooting"}},d={},l=[{value:"Default Fory Instance",id:"default-fory-instance",level:2},{value:"Why Not Thread-Safe?",id:"why-not-thread-safe",level:3},{value:"Thread-Safe Wrapper",id:"thread-safe-wrapper",level:2},{value:"How It Works",id:"how-it-works",level:3},{value:"API",id:"api",level:3},{value:"Type Registration",id:"type-registration",level:2},{value:"Thread-Safe Registration",id:"thread-safe-registration",level:3},{value:"Zero-Copy Considerations",id:"zero-copy-considerations",level:2},{value:"Non-Thread-Safe Instance",id:"non-thread-safe-instance",level:3},{value:"Thread-Safe Instance",id:"thread-safe-instance",level:3},{value:"Performance Comparison",id:"performance-comparison",level:2},{value:"Benchmarking",id:"benchmarking",level:3},{value:"Patterns",id:"patterns",level:2},{value:"Per-Goroutine Instance",id:"per-goroutine-instance",level:3},{value:"Shared Thread-Safe Instance",id:"shared-thread-safe-instance",level:3},{value:"HTTP Handler Example",id:"http-handler-example",level:3},{value:"Common Mistakes",id:"common-mistakes",level:2},{value:"Sharing Non-Thread-Safe Instance",id:"sharing-non-thread-safe-instance",level:3},{value:"Keeping Reference to Buffer",id:"keeping-reference-to-buffer",level:3},{value:"Registering Types Concurrently",id:"registering-types-concurrently",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Related Topics",id:"related-topics",level:2}];function c(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"This guide covers concurrent usage patterns for Fory Go, including the thread-safe wrapper and best practices for multi-goroutine environments."}),"\n",(0,a.jsx)(n.h2,{id:"default-fory-instance",children:"Default Fory Instance"}),"\n",(0,a.jsxs)(n.p,{children:["The default ",(0,a.jsx)(n.code,{children:"Fory"})," instance is ",(0,a.jsx)(n.strong,{children:"not thread-safe"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"f := fory.New()\n\n// NOT SAFE: Concurrent access from multiple goroutines\ngo func() {\n    f.Serialize(value1)  // Race condition!\n}()\ngo func() {\n    f.Serialize(value2)  // Race condition!\n}()\n"})}),"\n",(0,a.jsx)(n.h3,{id:"why-not-thread-safe",children:"Why Not Thread-Safe?"}),"\n",(0,a.jsx)(n.p,{children:"For performance, Fory reuses internal state:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Buffer is cleared and reused between calls"}),"\n",(0,a.jsx)(n.li,{children:"Reference resolvers are reset"}),"\n",(0,a.jsx)(n.li,{children:"Context objects are recycled"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"This avoids allocations but requires exclusive access."}),"\n",(0,a.jsx)(n.h2,{id:"thread-safe-wrapper",children:"Thread-Safe Wrapper"}),"\n",(0,a.jsxs)(n.p,{children:["For concurrent use, use the ",(0,a.jsx)(n.code,{children:"threadsafe"})," package:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:'import "github.com/apache/fory/go/fory/threadsafe"\n\n// Create thread-safe Fory\nf := threadsafe.New()\n\n// Safe for concurrent use\ngo func() {\n    data, _ := f.Serialize(value1)\n}()\ngo func() {\n    data, _ := f.Serialize(value2)\n}()\n'})}),"\n",(0,a.jsx)(n.h3,{id:"how-it-works",children:"How It Works"}),"\n",(0,a.jsxs)(n.p,{children:["The thread-safe wrapper uses ",(0,a.jsx)(n.code,{children:"sync.Pool"}),":"]}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Acquire"}),": Gets a Fory instance from the pool"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Use"}),": Performs serialization/deserialization"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Copy"}),": Copies result data (buffer will be reused)"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Release"}),": Returns instance to pool"]}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"// Simplified implementation\nfunc (f *Fory) Serialize(v any) ([]byte, error) {\n    fory := f.pool.Get().(*fory.Fory)\n    defer f.pool.Put(fory)\n\n    data, err := fory.Serialize(v)\n    if err != nil {\n        return nil, err\n    }\n\n    // Copy because underlying buffer will be reused\n    result := make([]byte, len(data))\n    copy(result, data)\n    return result, nil\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"api",children:"API"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"// Create thread-safe instance\nf := threadsafe.New()\n\n// Instance methods\ndata, err := f.Serialize(value)\nerr = f.Deserialize(data, &target)\n\n// Generic functions\ndata, err := threadsafe.Serialize(f, &value)\nerr = threadsafe.Deserialize(f, data, &target)\n\n// Global convenience functions\ndata, err := threadsafe.Marshal(&value)\nerr = threadsafe.Unmarshal(data, &target)\n"})}),"\n",(0,a.jsx)(n.h2,{id:"type-registration",children:"Type Registration"}),"\n",(0,a.jsx)(n.p,{children:"Type registration should be done before concurrent use:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"f := threadsafe.New()\n\n// Register types BEFORE concurrent access\nf.RegisterStruct(User{}, 1)\nf.RegisterStruct(Order{}, 2)\n\n// Now safe to use concurrently\ngo func() {\n    f.Serialize(&User{ID: 1})\n}()\n"})}),"\n",(0,a.jsx)(n.h3,{id:"thread-safe-registration",children:"Thread-Safe Registration"}),"\n",(0,a.jsx)(n.p,{children:"The thread-safe wrapper handles registration safely:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"// Safe: Registration is synchronized\nf := threadsafe.New()\nf.RegisterStruct(User{}, 1)  // Thread-safe\n"})}),"\n",(0,a.jsx)(n.p,{children:"However, for best performance, register all types at startup before concurrent use."}),"\n",(0,a.jsx)(n.h2,{id:"zero-copy-considerations",children:"Zero-Copy Considerations"}),"\n",(0,a.jsx)(n.h3,{id:"non-thread-safe-instance",children:"Non-Thread-Safe Instance"}),"\n",(0,a.jsx)(n.p,{children:"With the default Fory, returned byte slices are views into the internal buffer:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"f := fory.New()\n\ndata1, _ := f.Serialize(value1)\n// data1 is valid\n\ndata2, _ := f.Serialize(value2)\n// data1 is NOW INVALID (buffer was reused)\n"})}),"\n",(0,a.jsx)(n.h3,{id:"thread-safe-instance",children:"Thread-Safe Instance"}),"\n",(0,a.jsx)(n.p,{children:"The thread-safe wrapper copies data automatically:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"f := threadsafe.New()\n\ndata1, _ := f.Serialize(value1)\ndata2, _ := f.Serialize(value2)\n// Both data1 and data2 are valid (independent copies)\n"})}),"\n",(0,a.jsx)(n.p,{children:"This is safer but has allocation overhead."}),"\n",(0,a.jsx)(n.h2,{id:"performance-comparison",children:"Performance Comparison"}),"\n",(0,a.jsxs)(n.table,{children:[(0,a.jsx)(n.thead,{children:(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.th,{children:"Scenario"}),(0,a.jsx)(n.th,{children:"Non-Thread-Safe"}),(0,a.jsx)(n.th,{children:"Thread-Safe"})]})}),(0,a.jsxs)(n.tbody,{children:[(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Single goroutine"}),(0,a.jsx)(n.td,{children:"Fastest"}),(0,a.jsx)(n.td,{children:"Slower (pool overhead)"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Multiple goroutines"}),(0,a.jsx)(n.td,{children:"Unsafe"}),(0,a.jsx)(n.td,{children:"Safe, good scaling"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Memory allocations"}),(0,a.jsx)(n.td,{children:"Minimal"}),(0,a.jsx)(n.td,{children:"Per-call copy"})]}),(0,a.jsxs)(n.tr,{children:[(0,a.jsx)(n.td,{children:"Buffer reuse"}),(0,a.jsx)(n.td,{children:"Yes"}),(0,a.jsx)(n.td,{children:"Per-pool-instance"})]})]})]}),"\n",(0,a.jsx)(n.h3,{id:"benchmarking",children:"Benchmarking"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:'func BenchmarkNonThreadSafe(b *testing.B) {\n    f := fory.New()\n    f.RegisterStruct(User{}, 1)\n    user := &User{ID: 1, Name: "Alice"}\n\n    for i := 0; i < b.N; i++ {\n        data, _ := f.Serialize(user)\n        _ = data\n    }\n}\n\nfunc BenchmarkThreadSafe(b *testing.B) {\n    f := threadsafe.New()\n    f.RegisterStruct(User{}, 1)\n    user := &User{ID: 1, Name: "Alice"}\n\n    for i := 0; i < b.N; i++ {\n        data, _ := f.Serialize(user)\n        _ = data\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"patterns",children:"Patterns"}),"\n",(0,a.jsx)(n.h3,{id:"per-goroutine-instance",children:"Per-Goroutine Instance"}),"\n",(0,a.jsx)(n.p,{children:"For maximum performance with known goroutine count:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"func worker(id int) {\n    // Each worker has its own Fory instance\n    f := fory.New()\n    f.RegisterStruct(User{}, 1)\n\n    for task := range tasks {\n        data, _ := f.Serialize(task)\n        process(data)\n    }\n}\n\n// Start workers\nfor i := 0; i < numWorkers; i++ {\n    go worker(i)\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"shared-thread-safe-instance",children:"Shared Thread-Safe Instance"}),"\n",(0,a.jsx)(n.p,{children:"For dynamic goroutine count or simplicity:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"// Single shared instance\nvar f = threadsafe.New()\n\nfunc init() {\n    f.RegisterStruct(User{}, 1)\n}\n\nfunc handleRequest(user *User) []byte {\n    // Safe from any goroutine\n    data, _ := f.Serialize(user)\n    return data\n}\n"})}),"\n",(0,a.jsx)(n.h3,{id:"http-handler-example",children:"HTTP Handler Example"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:'var fory = threadsafe.New()\n\nfunc init() {\n    fory.RegisterStruct(Response{}, 1)\n}\n\nfunc handler(w http.ResponseWriter, r *http.Request) {\n    response := &Response{\n        Status: "ok",\n        Data:   getData(),\n    }\n\n    // Safe: threadsafe.Fory handles concurrency\n    data, err := fory.Serialize(response)\n    if err != nil {\n        http.Error(w, err.Error(), 500)\n        return\n    }\n\n    w.Header().Set("Content-Type", "application/octet-stream")\n    w.Write(data)\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"common-mistakes",children:"Common Mistakes"}),"\n",(0,a.jsx)(n.h3,{id:"sharing-non-thread-safe-instance",children:"Sharing Non-Thread-Safe Instance"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"// WRONG: Race condition\nvar f = fory.New()\n\nfunc handler1() {\n    f.Serialize(value1)  // Race!\n}\n\nfunc handler2() {\n    f.Serialize(value2)  // Race!\n}\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Fix"}),": Use ",(0,a.jsx)(n.code,{children:"threadsafe.New()"})," or per-goroutine instances."]}),"\n",(0,a.jsx)(n.h3,{id:"keeping-reference-to-buffer",children:"Keeping Reference to Buffer"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"// WRONG: Buffer invalidated on next call\nf := fory.New()\ndata, _ := f.Serialize(value1)\nsavedData := data  // Just copies the slice header!\n\nf.Serialize(value2)  // Invalidates data and savedData\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Fix"}),": Clone the data or use thread-safe wrapper."]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"// Correct: Clone the data\ndata, _ := f.Serialize(value1)\nsavedData := make([]byte, len(data))\ncopy(savedData, data)\n\n// Or use thread-safe (auto-copies)\nf := threadsafe.New()\ndata, _ := f.Serialize(value1)  // Already copied\n"})}),"\n",(0,a.jsx)(n.h3,{id:"registering-types-concurrently",children:"Registering Types Concurrently"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-go",children:"// RISKY: Concurrent registration\ngo func() {\n    f.RegisterStruct(TypeA{}, 1)\n}()\ngo func() {\n    f.Serialize(value)  // May not see TypeA\n}()\n"})}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.strong,{children:"Fix"}),": Register all types before concurrent use."]}),"\n",(0,a.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Register types at startup"}),": Before any concurrent operations"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Clone data if keeping references"}),": With non-thread-safe instance"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Use per-worker instances for hot paths"}),": Eliminates pool contention"]}),"\n",(0,a.jsxs)(n.li,{children:[(0,a.jsx)(n.strong,{children:"Profile before optimizing"}),": Thread-safe overhead may be negligible"]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"related-topics",children:"Related Topics"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/next/guide/go/configuration",children:"Configuration"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/next/guide/go/basic_serialization",children:"Basic Serialization"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"/docs/next/guide/go/troubleshooting",children:"Troubleshooting"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(c,{...e})}):c(e)}},11151:(e,n,r)=>{r.d(n,{Z:()=>o,a:()=>s});var a=r(67294);const i={},t=a.createContext(i);function s(e){const n=a.useContext(t);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),a.createElement(t.Provider,{value:n},e.children)}}}]);