"use strict";(self.webpackChunkfory_site=self.webpackChunkfory_site||[]).push([[69628],{96523:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>t,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var o=r(85893),i=r(11151);const a={title:"Advanced Features",sidebar_position:7,id:"advanced_features",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},t=void 0,s={id:"guide/java/advanced_features",title:"Advanced Features",description:"This page covers advanced features including zero-copy serialization, deep copy, memory management, and logging.",source:"@site/versioned_docs/version-0.15/guide/java/advanced-features.md",sourceDirName:"guide/java",slug:"/guide/java/advanced_features",permalink:"/docs/guide/java/advanced_features",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/fory-site/tree/main/docs/guide/java/advanced-features.md",tags:[],version:"0.15",sidebarPosition:7,frontMatter:{title:"Advanced Features",sidebar_position:7,id:"advanced_features",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},sidebar:"docsSidebar",previous:{title:"Compression",permalink:"/docs/guide/java/compression"},next:{title:"Cross-Language Serialization",permalink:"/docs/guide/java/cross_language"}},l={},c=[{value:"Zero-Copy Serialization",id:"zero-copy-serialization",level:2},{value:"Object Deep Copy",id:"object-deep-copy",level:2},{value:"With Reference Tracking",id:"with-reference-tracking",level:3},{value:"Without Reference Tracking (Better Performance)",id:"without-reference-tracking-better-performance",level:3},{value:"Memory Allocation Customization",id:"memory-allocation-customization",level:2},{value:"MemoryAllocator Interface",id:"memoryallocator-interface",level:3},{value:"Using Custom Memory Allocators",id:"using-custom-memory-allocators",level:3},{value:"Default Memory Allocator Behavior",id:"default-memory-allocator-behavior",level:3},{value:"Use Cases",id:"use-cases",level:3},{value:"Logging",id:"logging",level:2},{value:"ForyLogger",id:"forylogger",level:3},{value:"Slf4jLogger",id:"slf4jlogger",level:3},{value:"Suppress Fory Logs",id:"suppress-fory-logs",level:3},{value:"Related Topics",id:"related-topics",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.p,{children:"This page covers advanced features including zero-copy serialization, deep copy, memory management, and logging."}),"\n",(0,o.jsx)(n.h2,{id:"zero-copy-serialization",children:"Zero-Copy Serialization"}),"\n",(0,o.jsx)(n.p,{children:"Fory supports zero-copy serialization for efficient handling of large binary data:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'import org.apache.fory.*;\nimport org.apache.fory.config.*;\nimport org.apache.fory.serializer.BufferObject;\nimport org.apache.fory.memory.MemoryBuffer;\n\nimport java.util.*;\nimport java.util.stream.Collectors;\n\npublic class ZeroCopyExample {\n  // Note that fory instance should be reused instead of creation every time.\n  static Fory fory = Fory.builder()\n    .withLanguage(Language.JAVA)\n    .build();\n\n  public static void main(String[] args) {\n    List<Object> list = Arrays.asList("str", new byte[1000], new int[100], new double[100]);\n    Collection<BufferObject> bufferObjects = new ArrayList<>();\n    byte[] bytes = fory.serialize(list, e -> !bufferObjects.add(e));\n    List<MemoryBuffer> buffers = bufferObjects.stream()\n      .map(BufferObject::toBuffer).collect(Collectors.toList());\n    System.out.println(fory.deserialize(bytes, buffers));\n  }\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"object-deep-copy",children:"Object Deep Copy"}),"\n",(0,o.jsx)(n.p,{children:"Fory provides efficient deep copy functionality:"}),"\n",(0,o.jsx)(n.h3,{id:"with-reference-tracking",children:"With Reference Tracking"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"Fory fory = Fory.builder().withRefCopy(true).build();\nSomeClass a = xxx;\nSomeClass copied = fory.copy(a);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"without-reference-tracking-better-performance",children:"Without Reference Tracking (Better Performance)"}),"\n",(0,o.jsxs)(n.p,{children:["When disabled, deep copy will ignore circular and shared references. Same reference of an object graph will be copied into different objects in one ",(0,o.jsx)(n.code,{children:"Fory#copy"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"Fory fory = Fory.builder().withRefCopy(false).build();\nSomeClass a = xxx;\nSomeClass copied = fory.copy(a);\n"})}),"\n",(0,o.jsx)(n.h2,{id:"memory-allocation-customization",children:"Memory Allocation Customization"}),"\n",(0,o.jsxs)(n.p,{children:["Fory provides a ",(0,o.jsx)(n.code,{children:"MemoryAllocator"})," interface that allows you to customize how memory buffers are allocated and grown during serialization operations. This can be useful for performance optimization, memory pooling, or debugging memory usage."]}),"\n",(0,o.jsx)(n.h3,{id:"memoryallocator-interface",children:"MemoryAllocator Interface"}),"\n",(0,o.jsxs)(n.p,{children:["The ",(0,o.jsx)(n.code,{children:"MemoryAllocator"})," interface defines two key methods:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"public interface MemoryAllocator {\n  /**\n   * Allocates a new MemoryBuffer with the specified initial capacity.\n   */\n  MemoryBuffer allocate(int initialCapacity);\n\n  /**\n   * Grows an existing buffer to accommodate the new capacity.\n   * The implementation must grow the buffer in-place by modifying\n   * the existing buffer instance.\n   */\n  MemoryBuffer grow(MemoryBuffer buffer, int newCapacity);\n}\n"})}),"\n",(0,o.jsx)(n.h3,{id:"using-custom-memory-allocators",children:"Using Custom Memory Allocators"}),"\n",(0,o.jsxs)(n.p,{children:["You can set a global memory allocator that will be used by all ",(0,o.jsx)(n.code,{children:"MemoryBuffer"})," instances:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"// Create a custom allocator\nMemoryAllocator customAllocator = new MemoryAllocator() {\n  @Override\n  public MemoryBuffer allocate(int initialCapacity) {\n    // Add extra capacity for debugging or pooling\n    return MemoryBuffer.fromByteArray(new byte[initialCapacity + 100]);\n  }\n\n  @Override\n  public MemoryBuffer grow(MemoryBuffer buffer, int newCapacity) {\n    if (newCapacity <= buffer.size()) {\n      return buffer;\n    }\n\n    // Custom growth strategy - add 100% extra capacity\n    int newSize = (int) (newCapacity * 2);\n    byte[] data = new byte[newSize];\n    buffer.copyToUnsafe(0, data, Platform.BYTE_ARRAY_OFFSET, buffer.size());\n    buffer.initHeapBuffer(data, 0, data.length);\n    return buffer;\n  }\n};\n\n// Set the custom allocator globally\nMemoryBuffer.setGlobalAllocator(customAllocator);\n\n// All subsequent MemoryBuffer allocations will use your custom allocator\nFory fory = Fory.builder().withLanguage(Language.JAVA).build();\nbyte[] bytes = fory.serialize(someObject); // Uses custom allocator\n"})}),"\n",(0,o.jsx)(n.h3,{id:"default-memory-allocator-behavior",children:"Default Memory Allocator Behavior"}),"\n",(0,o.jsx)(n.p,{children:"The default allocator uses the following growth strategy:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["For buffers smaller than ",(0,o.jsx)(n.code,{children:"BUFFER_GROW_STEP_THRESHOLD"})," (100MB): multiply capacity by 2"]}),"\n",(0,o.jsxs)(n.li,{children:["For larger buffers: multiply capacity by 1.5 (capped at ",(0,o.jsx)(n.code,{children:"Integer.MAX_VALUE - 8"}),")"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"This provides a balance between avoiding frequent reallocations and preventing excessive memory usage."}),"\n",(0,o.jsx)(n.h3,{id:"use-cases",children:"Use Cases"}),"\n",(0,o.jsx)(n.p,{children:"Custom memory allocators are useful for:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Memory Pooling"}),": Reuse allocated buffers to reduce GC pressure"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Performance Tuning"}),": Use different growth strategies based on your workload"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Debugging"}),": Add logging or tracking to monitor memory usage"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Off-heap Memory"}),": Integrate with off-heap memory management systems"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"logging",children:"Logging"}),"\n",(0,o.jsx)(n.h3,{id:"forylogger",children:"ForyLogger"}),"\n",(0,o.jsxs)(n.p,{children:["By default, Fory uses a custom logger ",(0,o.jsx)(n.code,{children:"ForyLogger"})," for internal needs. It builds resulting logged data into a single string and sends it directly to ",(0,o.jsx)(n.code,{children:"System.out"}),". The result line layout is similar to (in Log4j notation):"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"%d{yyyy-MM-dd hh:mm:ss} %p  %C:%L [%t] - %m%n\n"})}),"\n",(0,o.jsx)(n.p,{children:"The layout can't be changed."}),"\n",(0,o.jsx)(n.p,{children:"Example output:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"2025-11-07 08:49:59 INFO  CompileUnit:55 [main] - Generate code for org.apache.fory.builder.SerializedLambdaForyCodec_0 took 35 ms.\n2025-11-07 08:50:00 INFO  JaninoUtils:121 [main] - Compile [SerializedLambdaForyCodec_0] take 144 ms\n"})}),"\n",(0,o.jsx)(n.h3,{id:"slf4jlogger",children:"Slf4jLogger"}),"\n",(0,o.jsxs)(n.p,{children:["If a more sophisticated logger is required, configure Fory to use Slf4j via ",(0,o.jsx)(n.code,{children:"LoggerFactory.useSlf4jLogging()"}),". For example, enabling Slf4j before creating Fory:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"public static final ThreadSafeFory FORY;\n\nstatic {\n  LoggerFactory.useSlf4jLogging(true);\n  FORY = Fory.builder()\n    .buildThreadSafeFory();\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Note:"})," Enabling Slf4j via ",(0,o.jsx)(n.code,{children:"useSlf4jLogging"})," will be ignored when the application runs in a GraalVM native image."]}),"\n",(0,o.jsx)(n.h3,{id:"suppress-fory-logs",children:"Suppress Fory Logs"}),"\n",(0,o.jsxs)(n.p,{children:["Both ",(0,o.jsx)(n.code,{children:"ForyLogger"})," and ",(0,o.jsx)(n.code,{children:"Slf4jLogger"})," allow controlling log output level or suppressing logs entirely. Configure logger level via ",(0,o.jsx)(n.code,{children:"LoggerFactory.setLogLevel()"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"static {\n  // to log only WARN and higher\n  LoggerFactory.setLogLevel(LogLevel.WARN_LEVEL);\n\n  // to disable logging entirely\n  LoggerFactory.disableLogging();\n}\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Note:"})," Selected logging level is applied before Slf4j implementation's logger level. So if you set ",(0,o.jsx)(n.code,{children:"WARN_LEVEL"})," (as in the example above) then you will not see INFO messages from Fory even if INFO is enabled in Logback."]}),"\n",(0,o.jsx)(n.h2,{id:"related-topics",children:"Related Topics"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"/docs/guide/java/compression",children:"Compression"})," - Data compression options"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"/docs/guide/java/configuration",children:"Configuration Options"})," - All ForyBuilder options"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"/docs/guide/java/cross_language",children:"Cross-Language Serialization"})," - XLANG mode"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},11151:(e,n,r)=>{r.d(n,{Z:()=>s,a:()=>t});var o=r(67294);const i={},a=o.createContext(i);function t(e){const n=o.useContext(a);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),o.createElement(a.Provider,{value:n},e.children)}}}]);