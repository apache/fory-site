"use strict";(self.webpackChunkfory_site=self.webpackChunkfory_site||[]).push([[41433],{57071:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>t,metadata:()=>d,toc:()=>l});var i=n(85893),s=n(11151);const t={title:"Shared & Circular References",sidebar_position:5,id:"references",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},c=void 0,d={id:"guide/rust/references",title:"Shared & Circular References",description:"Apache Fory\u2122 automatically tracks and preserves reference identity for shared objects using Rc and Arc.",source:"@site/versioned_docs/version-0.15/guide/rust/references.md",sourceDirName:"guide/rust",slug:"/guide/rust/references",permalink:"/docs/guide/rust/references",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/fory-site/tree/main/docs/guide/rust/references.md",tags:[],version:"0.15",sidebarPosition:5,frontMatter:{title:"Shared & Circular References",sidebar_position:5,id:"references",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},sidebar:"docsSidebar",previous:{title:"Field Configuration",permalink:"/docs/guide/rust/field_configuration"},next:{title:"Trait Object Serialization",permalink:"/docs/guide/rust/polymorphism"}},a={},l=[{value:"Shared References",id:"shared-references",level:2},{value:"Shared References with Rc",id:"shared-references-with-rc",level:3},{value:"Shared References with Arc",id:"shared-references-with-arc",level:3},{value:"Circular References with Weak Pointers",id:"circular-references-with-weak-pointers",level:2},{value:"Circular References with RcWeak",id:"circular-references-with-rcweak",level:3},{value:"Thread-Safe Circular Graphs with Arc",id:"thread-safe-circular-graphs-with-arc",level:3},{value:"Supported Smart Pointer Types",id:"supported-smart-pointer-types",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"Related Topics",id:"related-topics",level:2}];function o(e){const r={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(r.p,{children:["Apache Fory\u2122 automatically tracks and preserves reference identity for shared objects using ",(0,i.jsx)(r.code,{children:"Rc<T>"})," and ",(0,i.jsx)(r.code,{children:"Arc<T>"}),"."]}),"\n",(0,i.jsx)(r.h2,{id:"shared-references",children:"Shared References"}),"\n",(0,i.jsx)(r.p,{children:"When the same object is referenced multiple times, Fory serializes it only once and uses reference IDs for subsequent occurrences. This ensures:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Space efficiency"}),": No data duplication in serialized output"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Reference identity preservation"}),": Deserialized objects maintain the same sharing relationships"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Circular reference support"}),": Use ",(0,i.jsx)(r.code,{children:"RcWeak<T>"})," and ",(0,i.jsx)(r.code,{children:"ArcWeak<T>"})," to break cycles"]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"shared-references-with-rc",children:"Shared References with Rc"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-rust",children:'use fory::Fory;\nuse std::rc::Rc;\n\nlet fory = Fory::default();\n\n// Create a shared value\nlet shared = Rc::new(String::from("shared_value"));\n\n// Reference it multiple times\nlet data = vec![shared.clone(), shared.clone(), shared.clone()];\n\n// The shared value is serialized only once\nlet bytes = fory.serialize(&data);\nlet decoded: Vec<Rc<String>> = fory.deserialize(&bytes)?;\n\n// Verify reference identity is preserved\nassert_eq!(decoded.len(), 3);\nassert_eq!(*decoded[0], "shared_value");\n\n// All three Rc pointers point to the same object\nassert!(Rc::ptr_eq(&decoded[0], &decoded[1]));\nassert!(Rc::ptr_eq(&decoded[1], &decoded[2]));\n'})}),"\n",(0,i.jsx)(r.h3,{id:"shared-references-with-arc",children:"Shared References with Arc"}),"\n",(0,i.jsxs)(r.p,{children:["For thread-safe shared references, use ",(0,i.jsx)(r.code,{children:"Arc<T>"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-rust",children:'use fory::Fory;\nuse std::sync::Arc;\n\nlet fory = Fory::default();\n\nlet shared = Arc::new(String::from("shared_value"));\nlet data = vec![shared.clone(), shared.clone()];\n\nlet bytes = fory.serialize(&data);\nlet decoded: Vec<Arc<String>> = fory.deserialize(&bytes)?;\n\nassert!(Arc::ptr_eq(&decoded[0], &decoded[1]));\n'})}),"\n",(0,i.jsx)(r.h2,{id:"circular-references-with-weak-pointers",children:"Circular References with Weak Pointers"}),"\n",(0,i.jsxs)(r.p,{children:["To serialize circular references like parent-child relationships or doubly-linked structures, use ",(0,i.jsx)(r.code,{children:"RcWeak<T>"})," or ",(0,i.jsx)(r.code,{children:"ArcWeak<T>"})," to break the cycle."]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"How it works:"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Weak pointers serialize as references to their target objects"}),"\n",(0,i.jsxs)(r.li,{children:["If the strong pointer has been dropped, weak serializes as ",(0,i.jsx)(r.code,{children:"Null"})]}),"\n",(0,i.jsx)(r.li,{children:"Forward references (weak appearing before target) are resolved via callbacks"}),"\n",(0,i.jsx)(r.li,{children:"All clones of a weak pointer share the same internal cell for automatic updates"}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"circular-references-with-rcweak",children:"Circular References with RcWeak"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-rust",children:"use fory::{Fory, Error};\nuse fory::ForyObject;\nuse fory::RcWeak;\nuse std::rc::Rc;\nuse std::cell::RefCell;\n\n#[derive(ForyObject, Debug)]\nstruct Node {\n    value: i32,\n    parent: RcWeak<RefCell<Node>>,\n    children: Vec<Rc<RefCell<Node>>>,\n}\n\nlet mut fory = Fory::default();\nfory.register::<Node>(2000);\n\n// Build a parent-child tree\nlet parent = Rc::new(RefCell::new(Node {\n    value: 1,\n    parent: RcWeak::new(),\n    children: vec![],\n}));\n\nlet child1 = Rc::new(RefCell::new(Node {\n    value: 2,\n    parent: RcWeak::from(&parent),\n    children: vec![],\n}));\n\nlet child2 = Rc::new(RefCell::new(Node {\n    value: 3,\n    parent: RcWeak::from(&parent),\n    children: vec![],\n}));\n\nparent.borrow_mut().children.push(child1.clone());\nparent.borrow_mut().children.push(child2.clone());\n\n// Serialize and deserialize the circular structure\nlet bytes = fory.serialize(&parent);\nlet decoded: Rc<RefCell<Node>> = fory.deserialize(&bytes)?;\n\n// Verify the circular relationship\nassert_eq!(decoded.borrow().children.len(), 2);\nfor child in &decoded.borrow().children {\n    let upgraded_parent = child.borrow().parent.upgrade().unwrap();\n    assert!(Rc::ptr_eq(&decoded, &upgraded_parent));\n}\n"})}),"\n",(0,i.jsx)(r.h3,{id:"thread-safe-circular-graphs-with-arc",children:"Thread-Safe Circular Graphs with Arc"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-rust",children:"use fory::{Fory, Error};\nuse fory::ForyObject;\nuse fory::ArcWeak;\nuse std::sync::{Arc, Mutex};\n\n#[derive(ForyObject)]\nstruct Node {\n    val: i32,\n    parent: ArcWeak<Mutex<Node>>,\n    children: Vec<Arc<Mutex<Node>>>,\n}\n\nlet mut fory = Fory::default();\nfory.register::<Node>(6000);\n\nlet parent = Arc::new(Mutex::new(Node {\n    val: 10,\n    parent: ArcWeak::new(),\n    children: vec![],\n}));\n\nlet child1 = Arc::new(Mutex::new(Node {\n    val: 20,\n    parent: ArcWeak::from(&parent),\n    children: vec![],\n}));\n\nlet child2 = Arc::new(Mutex::new(Node {\n    val: 30,\n    parent: ArcWeak::from(&parent),\n    children: vec![],\n}));\n\nparent.lock().unwrap().children.push(child1.clone());\nparent.lock().unwrap().children.push(child2.clone());\n\nlet bytes = fory.serialize(&parent);\nlet decoded: Arc<Mutex<Node>> = fory.deserialize(&bytes)?;\n\nassert_eq!(decoded.lock().unwrap().children.len(), 2);\nfor child in &decoded.lock().unwrap().children {\n    let upgraded_parent = child.lock().unwrap().parent.upgrade().unwrap();\n    assert!(Arc::ptr_eq(&decoded, &upgraded_parent));\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"supported-smart-pointer-types",children:"Supported Smart Pointer Types"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Type"}),(0,i.jsx)(r.th,{children:"Description"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"Rc<T>"})}),(0,i.jsx)(r.td,{children:"Reference counting, shared refs tracked"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"Arc<T>"})}),(0,i.jsx)(r.td,{children:"Thread-safe reference counting, shared refs tracked"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"RcWeak<T>"})}),(0,i.jsxs)(r.td,{children:["Weak reference to ",(0,i.jsx)(r.code,{children:"Rc<T>"}),", breaks circular refs"]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"ArcWeak<T>"})}),(0,i.jsxs)(r.td,{children:["Weak reference to ",(0,i.jsx)(r.code,{children:"Arc<T>"}),", breaks circular refs"]})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"RefCell<T>"})}),(0,i.jsx)(r.td,{children:"Interior mutability with runtime borrow checking"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:(0,i.jsx)(r.code,{children:"Mutex<T>"})}),(0,i.jsx)(r.td,{children:"Thread-safe interior mutability"})]})]})]}),"\n",(0,i.jsx)(r.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Use Rc/Arc for shared data"}),": Let Fory handle deduplication"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Use weak pointers for cycles"}),": Prevent infinite recursion"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Prefer Arc for thread-safe scenarios"}),": When data crosses thread boundaries"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Combine with RefCell/Mutex"}),": For interior mutability"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"related-topics",children:"Related Topics"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/docs/guide/rust/basic_serialization",children:"Basic Serialization"})," - Supported types"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/docs/guide/rust/polymorphism",children:"Polymorphism"})," - Trait objects with Rc/Arc"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"/docs/guide/rust/configuration",children:"Configuration"})," - Reference tracking options"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,s.a)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},11151:(e,r,n)=>{n.d(r,{Z:()=>d,a:()=>c});var i=n(67294);const s={},t=i.createContext(s);function c(e){const r=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function d(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),i.createElement(t.Provider,{value:r},e.children)}}}]);