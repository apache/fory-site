"use strict";(self.webpackChunkfory_site=self.webpackChunkfory_site||[]).push([[26845],{74866:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>s,default:()=>d,frontMatter:()=>l,metadata:()=>a,toc:()=>c});var r=i(85893),t=i(11151);const l={title:"\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",sidebar_position:4,id:"custom_serializers",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},s=void 0,a={id:"guide/java/custom_serializers",title:"\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",description:"\u672c\u9875\u4ecb\u7ecd\u5982\u4f55\u4e3a\u4f60\u7684\u7c7b\u578b\u5b9e\u73b0\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668\u3002",source:"@site/i18n/zh-CN/docusaurus-plugin-content-docs/version-0.14/guide/java/custom-serializers.md",sourceDirName:"guide/java",slug:"/guide/java/custom_serializers",permalink:"/zh-CN/docs/0.14/guide/java/custom_serializers",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/fory-site/tree/main/i18n/zh-CN/docusaurus-plugin-content-docs/version-0.14/guide/java/custom-serializers.md",tags:[],version:"0.14",sidebarPosition:4,frontMatter:{title:"\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",sidebar_position:4,id:"custom_serializers",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},sidebar:"docsSidebar",previous:{title:"\u7c7b\u578b\u6ce8\u518c\u4e0e\u5b89\u5168",permalink:"/zh-CN/docs/0.14/guide/java/type_registration"},next:{title:"Schema \u6f14\u5316",permalink:"/zh-CN/docs/0.14/guide/java/schema_evolution"}},o={},c=[{value:"\u57fa\u672c\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",id:"\u57fa\u672c\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",level:2},{value:"\u6ce8\u518c\u5e8f\u5217\u5316\u5668",id:"\u6ce8\u518c\u5e8f\u5217\u5316\u5668",level:3},{value:"\u96c6\u5408\u5e8f\u5217\u5316\u5668",id:"\u96c6\u5408\u5e8f\u5217\u5316\u5668",level:2},{value:"supportCodegenHook \u53c2\u6570",id:"supportcodegenhook-\u53c2\u6570",level:3},{value:"\u5e26 JIT \u652f\u6301\u7684\u96c6\u5408\u5e8f\u5217\u5316\u5668",id:"\u5e26-jit-\u652f\u6301\u7684\u96c6\u5408\u5e8f\u5217\u5316\u5668",level:3},{value:"\u4e0d\u5e26 JIT \u7684\u81ea\u5b9a\u4e49\u96c6\u5408\u5e8f\u5217\u5316\u5668",id:"\u4e0d\u5e26-jit-\u7684\u81ea\u5b9a\u4e49\u96c6\u5408\u5e8f\u5217\u5316\u5668",level:3},{value:"\u7c7b\u96c6\u5408\u7c7b\u578b\u5e8f\u5217\u5316\u5668",id:"\u7c7b\u96c6\u5408\u7c7b\u578b\u5e8f\u5217\u5316\u5668",level:3},{value:"Map \u5e8f\u5217\u5316\u5668",id:"map-\u5e8f\u5217\u5316\u5668",level:2},{value:"\u5e26 JIT \u652f\u6301\u7684 Map \u5e8f\u5217\u5316\u5668",id:"\u5e26-jit-\u652f\u6301\u7684-map-\u5e8f\u5217\u5316\u5668",level:3},{value:"\u4e0d\u5e26 JIT \u7684\u81ea\u5b9a\u4e49 Map \u5e8f\u5217\u5316\u5668",id:"\u4e0d\u5e26-jit-\u7684\u81ea\u5b9a\u4e49-map-\u5e8f\u5217\u5316\u5668",level:3},{value:"\u7c7b Map \u7c7b\u578b\u5e8f\u5217\u5316\u5668",id:"\u7c7b-map-\u7c7b\u578b\u5e8f\u5217\u5316\u5668",level:3},{value:"\u6ce8\u518c\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",id:"\u6ce8\u518c\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",level:2},{value:"\u5173\u952e\u70b9",id:"\u5173\u952e\u70b9",level:2},{value:"\u76f8\u5173\u4e3b\u9898",id:"\u76f8\u5173\u4e3b\u9898",level:2}];function u(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"\u672c\u9875\u4ecb\u7ecd\u5982\u4f55\u4e3a\u4f60\u7684\u7c7b\u578b\u5b9e\u73b0\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u57fa\u672c\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",children:"\u57fa\u672c\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u4f60\u53ef\u80fd\u60f3\u4e3a\u4f60\u7684\u7c7b\u578b\u5b9e\u73b0\u5e8f\u5217\u5316\u5668\uff0c\u7279\u522b\u662f\u5bf9\u4e8e\u4f7f\u7528 JDK ",(0,r.jsx)(n.code,{children:"writeObject/writeReplace/readObject/readResolve"})," \u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u7684\u7c7b\uff0c\u8fd9\u975e\u5e38\u4f4e\u6548\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u4e0d\u60f3\u8c03\u7528\u4ee5\u4e0b ",(0,r.jsx)(n.code,{children:"Foo#writeObject"}),"\uff0c\u4f60\u53ef\u4ee5\u5b9e\u73b0\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"class Foo {\n  public long f1;\n\n  private void writeObject(ObjectOutputStream s) throws IOException {\n    System.out.println(f1);\n    s.defaultWriteObject();\n  }\n}\n\nclass FooSerializer extends Serializer<Foo> {\n  public FooSerializer(Fory fory) {\n    super(fory, Foo.class);\n  }\n\n  @Override\n  public void write(MemoryBuffer buffer, Foo value) {\n    buffer.writeInt64(value.f1);\n  }\n\n  @Override\n  public Foo read(MemoryBuffer buffer) {\n    Foo foo = new Foo();\n    foo.f1 = buffer.readInt64();\n    return foo;\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u6ce8\u518c\u5e8f\u5217\u5316\u5668",children:"\u6ce8\u518c\u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"Fory fory = getFory();\nfory.registerSerializer(Foo.class, new FooSerializer(fory));\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u9664\u4e86\u6ce8\u518c\u5e8f\u5217\u5316\u5668\uff0c\u4f60\u8fd8\u53ef\u4ee5\u4e3a\u7c7b\u5b9e\u73b0 ",(0,r.jsx)(n.code,{children:"java.io.Externalizable"})," \u6765\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u903b\u8f91\u3002\u8fd9\u79cd\u7c7b\u578b\u5c06\u7531 Fory \u7684 ",(0,r.jsx)(n.code,{children:"ExternalizableSerializer"})," \u5e8f\u5217\u5316\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"\u96c6\u5408\u5e8f\u5217\u5316\u5668",children:"\u96c6\u5408\u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u4e3a\u81ea\u5b9a\u4e49\u96c6\u5408\u7c7b\u578b\u5b9e\u73b0\u5e8f\u5217\u5316\u5668\u65f6\uff0c\u4f60\u5fc5\u987b\u6269\u5c55 ",(0,r.jsx)(n.code,{children:"CollectionSerializer"})," \u6216 ",(0,r.jsx)(n.code,{children:"CollectionLikeSerializer"}),"\u3002\u4e3b\u8981\u533a\u522b\u662f ",(0,r.jsx)(n.code,{children:"CollectionLikeSerializer"})," \u53ef\u4ee5\u5e8f\u5217\u5316\u5177\u6709\u7c7b\u4f3c\u96c6\u5408\u7ed3\u6784\u4f46\u4e0d\u662f Java Collection \u5b50\u7c7b\u578b\u7684\u7c7b\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"supportcodegenhook-\u53c2\u6570",children:"supportCodegenHook \u53c2\u6570"}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u4e2a\u7279\u6b8a\u53c2\u6570\u63a7\u5236\u5e8f\u5217\u5316\u884c\u4e3a\uff1a"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["\u5f53\u4e3a ",(0,r.jsx)(n.code,{children:"true"})," \u65f6\uff1a"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u542f\u7528\u5bf9\u96c6\u5408\u5143\u7d20\u7684\u4f18\u5316\u8bbf\u95ee\u548c JIT \u7f16\u8bd1\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd"}),"\n",(0,r.jsx)(n.li,{children:"\u76f4\u63a5\u5e8f\u5217\u5316\u8c03\u7528\u548c\u5185\u8054\u96c6\u5408\u9879\uff0c\u65e0\u9700\u52a8\u6001\u5e8f\u5217\u5316\u5668\u5206\u6d3e\u6210\u672c"}),"\n",(0,r.jsx)(n.li,{children:"\u5bf9\u6807\u51c6\u96c6\u5408\u7c7b\u578b\u6709\u66f4\u597d\u7684\u6027\u80fd"}),"\n",(0,r.jsx)(n.li,{children:"\u5bf9\u5927\u591a\u6570\u96c6\u5408\u63a8\u8350"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["\u5f53\u4e3a ",(0,r.jsx)(n.code,{children:"false"})," \u65f6\uff1a"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4f7f\u7528\u57fa\u4e8e\u63a5\u53e3\u7684\u5143\u7d20\u8bbf\u95ee\u548c\u5143\u7d20\u7684\u52a8\u6001\u5e8f\u5217\u5316\u5668\u5206\u6d3e\uff08\u6210\u672c\u66f4\u9ad8\uff09"}),"\n",(0,r.jsx)(n.li,{children:"\u5bf9\u81ea\u5b9a\u4e49\u96c6\u5408\u7c7b\u578b\u66f4\u7075\u6d3b"}),"\n",(0,r.jsx)(n.li,{children:"\u5f53\u96c6\u5408\u6709\u7279\u6b8a\u5e8f\u5217\u5316\u9700\u6c42\u65f6\u9700\u8981"}),"\n",(0,r.jsx)(n.li,{children:"\u5904\u7406\u590d\u6742\u7684\u96c6\u5408\u5b9e\u73b0"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u5e26-jit-\u652f\u6301\u7684\u96c6\u5408\u5e8f\u5217\u5316\u5668",children:"\u5e26 JIT \u652f\u6301\u7684\u96c6\u5408\u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u5728\u5b9e\u73b0\u5e26 JIT \u652f\u6301\u7684\u96c6\u5408\u5e8f\u5217\u5316\u5668\u65f6\uff0c\u5229\u7528 Fory \u73b0\u6709\u7684\u4e8c\u8fdb\u5236\u683c\u5f0f\u548c\u96c6\u5408\u5e8f\u5217\u5316\u57fa\u7840\u8bbe\u65bd\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public class CustomCollectionSerializer<T extends Collection> extends CollectionSerializer<T> {\n    public CustomCollectionSerializer(Fory fory, Class<T> cls) {\n        // supportCodegenHook \u63a7\u5236\u662f\u5426\u4f7f\u7528 JIT \u7f16\u8bd1\n        super(fory, cls, true);\n    }\n\n    @Override\n    public Collection onCollectionWrite(MemoryBuffer buffer, T value) {\n        // \u5199\u5165\u96c6\u5408\u5927\u5c0f\n        buffer.writeVarUint32Small7(value.size());\n        // \u5199\u5165\u4efb\u4f55\u989d\u5916\u7684\u96c6\u5408\u5143\u6570\u636e\n        return value;\n    }\n\n    @Override\n    public Collection newCollection(MemoryBuffer buffer) {\n        // \u521b\u5efa\u65b0\u7684\u96c6\u5408\u5b9e\u4f8b\n        Collection collection = super.newCollection(buffer);\n        // \u8bfb\u53d6\u5e76\u8bbe\u7f6e\u96c6\u5408\u5927\u5c0f\n        int numElements = getAndClearNumElements();\n        setNumElements(numElements);\n        return collection;\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6ce8\u610f\uff1a\u5728\u5b9e\u73b0 ",(0,r.jsx)(n.code,{children:"newCollection"})," \u65f6\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"setNumElements"}),"\uff0c\u8ba9 Fory \u77e5\u9053\u8981\u53cd\u5e8f\u5217\u5316\u591a\u5c11\u5143\u7d20\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u4e0d\u5e26-jit-\u7684\u81ea\u5b9a\u4e49\u96c6\u5408\u5e8f\u5217\u5316\u5668",children:"\u4e0d\u5e26 JIT \u7684\u81ea\u5b9a\u4e49\u96c6\u5408\u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u5bf9\u4e8e\u4f7f\u7528\u539f\u59cb\u6570\u7ec4\u6216\u6709\u7279\u6b8a\u8981\u6c42\u7684\u96c6\u5408\uff0c\u5b9e\u73b0\u7981\u7528 JIT \u7684\u5e8f\u5217\u5316\u5668\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"class IntList extends AbstractCollection<Integer> {\n    private final int[] elements;\n    private final int size;\n\n    public IntList(int size) {\n        this.elements = new int[size];\n        this.size = size;\n    }\n\n    public IntList(int[] elements, int size) {\n        this.elements = elements;\n        this.size = size;\n    }\n\n    @Override\n    public Iterator<Integer> iterator() {\n        return new Iterator<Integer>() {\n            private int index = 0;\n\n            @Override\n            public boolean hasNext() {\n                return index < size;\n            }\n\n            @Override\n            public Integer next() {\n                if (!hasNext()) {\n                    throw new NoSuchElementException();\n                }\n                return elements[index++];\n            }\n        };\n    }\n\n    @Override\n    public int size() {\n        return size;\n    }\n\n    public int get(int index) {\n        if (index >= size) {\n            throw new IndexOutOfBoundsException();\n        }\n        return elements[index];\n    }\n\n    public void set(int index, int value) {\n        if (index >= size) {\n            throw new IndexOutOfBoundsException();\n        }\n        elements[index] = value;\n    }\n\n    public int[] getElements() {\n        return elements;\n    }\n}\n\nclass IntListSerializer extends CollectionLikeSerializer<IntList> {\n    public IntListSerializer(Fory fory) {\n        // \u7981\u7528 JIT\uff0c\u56e0\u4e3a\u6211\u4eec\u76f4\u63a5\u5904\u7406\u5e8f\u5217\u5316\n        super(fory, IntList.class, false);\n    }\n\n    @Override\n    public void write(MemoryBuffer buffer, IntList value) {\n        // \u5199\u5165\u5927\u5c0f\n        buffer.writeVarUint32Small7(value.size());\n\n        // \u76f4\u63a5\u5c06\u5143\u7d20\u5199\u4e3a\u539f\u59cb int\n        int[] elements = value.getElements();\n        for (int i = 0; i < value.size(); i++) {\n            buffer.writeVarInt32(elements[i]);\n        }\n    }\n\n    @Override\n    public IntList read(MemoryBuffer buffer) {\n        // \u8bfb\u53d6\u5927\u5c0f\n        int size = buffer.readVarUint32Small7();\n\n        // \u521b\u5efa\u6570\u7ec4\u5e76\u8bfb\u53d6\u5143\u7d20\n        int[] elements = new int[size];\n        for (int i = 0; i < size; i++) {\n            elements[i] = buffer.readVarInt32();\n        }\n\n        return new IntList(elements, size);\n    }\n\n    // \u5f53\u7981\u7528 JIT \u65f6\u4e0d\u4f7f\u7528\u8fd9\u4e9b\u65b9\u6cd5\n    @Override\n    public Collection onCollectionWrite(MemoryBuffer buffer, IntList value) {\n        throw new UnsupportedOperationException();\n    }\n\n    @Override\n    public Collection newCollection(MemoryBuffer buffer) {\n        throw new UnsupportedOperationException();\n    }\n\n    @Override\n    public IntList onCollectionRead(Collection collection) {\n        throw new UnsupportedOperationException();\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"\u4f55\u65f6\u4f7f\u7528\u6b64\u65b9\u6cd5\uff1a"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u5904\u7406\u539f\u59cb\u7c7b\u578b"}),"\n",(0,r.jsx)(n.li,{children:"\u9700\u8981\u6700\u5927\u6027\u80fd"}),"\n",(0,r.jsx)(n.li,{children:"\u60f3\u8981\u6700\u5c0f\u5316\u5185\u5b58\u5f00\u9500"}),"\n",(0,r.jsx)(n.li,{children:"\u6709\u7279\u6b8a\u7684\u5e8f\u5217\u5316\u9700\u6c42"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u7c7b\u96c6\u5408\u7c7b\u578b\u5e8f\u5217\u5316\u5668",children:"\u7c7b\u96c6\u5408\u7c7b\u578b\u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u5bf9\u4e8e\u884c\u4e3a\u7c7b\u4f3c\u96c6\u5408\u4f46\u4e0d\u662f\u6807\u51c6 Java \u96c6\u5408\u7684\u7c7b\u578b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'class CustomCollectionLike {\n    private final Object[] elements;\n    private final int size;\n\n    public CustomCollectionLike(int size) {\n        this.elements = new Object[size];\n        this.size = 0;\n    }\n\n    public CustomCollectionLike(Object[] elements, int size) {\n        this.elements = elements;\n        this.size = size;\n    }\n\n    public Object get(int index) {\n        if (index >= size) {\n            throw new IndexOutOfBoundsException();\n        }\n        return elements[index];\n    }\n\n    public int size() {\n        return size;\n    }\n\n    public Object[] getElements() {\n        return elements;\n    }\n}\n\nclass CollectionView extends AbstractCollection<Object> {\n    private final Object[] elements;\n    private final int size;\n    private int writeIndex;\n\n    public CollectionView(CustomCollectionLike collection) {\n        this.elements = collection.getElements();\n        this.size = collection.size();\n    }\n\n    public CollectionView(int size) {\n        this.size = size;\n        this.elements = new Object[size];\n    }\n\n    @Override\n    public Iterator<Object> iterator() {\n        return new Iterator<Object>() {\n            private int index = 0;\n\n            @Override\n            public boolean hasNext() {\n                return index < size;\n            }\n\n            @Override\n            public Object next() {\n                if (!hasNext()) {\n                    throw new NoSuchElementException();\n                }\n                return elements[index++];\n            }\n        };\n    }\n\n    @Override\n    public boolean add(Object element) {\n        if (writeIndex >= size) {\n            throw new IllegalStateException("Collection is full");\n        }\n        elements[writeIndex++] = element;\n        return true;\n    }\n\n    @Override\n    public int size() {\n        return size;\n    }\n\n    public Object[] getElements() {\n        return elements;\n    }\n}\n\nclass CustomCollectionSerializer extends CollectionLikeSerializer<CustomCollectionLike> {\n    public CustomCollectionSerializer(Fory fory) {\n        super(fory, CustomCollectionLike.class, true);\n    }\n\n    @Override\n    public Collection onCollectionWrite(MemoryBuffer buffer, CustomCollectionLike value) {\n        buffer.writeVarUint32Small7(value.size());\n        return new CollectionView(value);\n    }\n\n    @Override\n    public Collection newCollection(MemoryBuffer buffer) {\n        int numElements = buffer.readVarUint32Small7();\n        setNumElements(numElements);\n        return new CollectionView(numElements);\n    }\n\n    @Override\n    public CustomCollectionLike onCollectionRead(Collection collection) {\n        CollectionView view = (CollectionView) collection;\n        return new CustomCollectionLike(view.getElements(), view.size());\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"map-\u5e8f\u5217\u5316\u5668",children:"Map \u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u4e3a\u81ea\u5b9a\u4e49 Map \u7c7b\u578b\u5b9e\u73b0\u5e8f\u5217\u5316\u5668\u65f6\uff0c\u6269\u5c55 ",(0,r.jsx)(n.code,{children:"MapSerializer"})," \u6216 ",(0,r.jsx)(n.code,{children:"MapLikeSerializer"}),"\u3002\u4e3b\u8981\u533a\u522b\u662f ",(0,r.jsx)(n.code,{children:"MapLikeSerializer"})," \u53ef\u4ee5\u5e8f\u5217\u5316\u5177\u6709\u7c7b\u4f3c map \u7ed3\u6784\u4f46\u4e0d\u662f Java Map \u5b50\u7c7b\u578b\u7684\u7c7b\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u5e26-jit-\u652f\u6301\u7684-map-\u5e8f\u5217\u5316\u5668",children:"\u5e26 JIT \u652f\u6301\u7684 Map \u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public class CustomMapSerializer<T extends Map> extends MapSerializer<T> {\n    public CustomMapSerializer(Fory fory, Class<T> cls) {\n        // supportCodegenHook \u662f\u51b3\u5b9a\u5e8f\u5217\u5316\u884c\u4e3a\u7684\u5173\u952e\u53c2\u6570\n        super(fory, cls, true);\n    }\n\n    @Override\n    public Map onMapWrite(MemoryBuffer buffer, T value) {\n        // \u5199\u5165 map \u5927\u5c0f\n        buffer.writeVarUint32Small7(value.size());\n        // \u5728\u8fd9\u91cc\u5199\u5165\u4efb\u4f55\u989d\u5916\u7684 map \u5143\u6570\u636e\n        return value;\n    }\n\n    @Override\n    public Map newMap(MemoryBuffer buffer) {\n        // \u8bfb\u53d6 map \u5927\u5c0f\n        int numElements = buffer.readVarUint32Small7();\n        setNumElements(numElements);\n        // \u521b\u5efa\u5e76\u8fd4\u56de\u65b0\u7684 map \u5b9e\u4f8b\n        T map = (T) new HashMap(numElements);\n        fory.getRefResolver().reference(map);\n        return map;\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6ce8\u610f\uff1a\u5728\u5b9e\u73b0 ",(0,r.jsx)(n.code,{children:"newMap"})," \u65f6\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"setNumElements"}),"\uff0c\u8ba9 Fory \u77e5\u9053\u8981\u53cd\u5e8f\u5217\u5316\u591a\u5c11\u5143\u7d20\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u4e0d\u5e26-jit-\u7684\u81ea\u5b9a\u4e49-map-\u5e8f\u5217\u5316\u5668",children:"\u4e0d\u5e26 JIT \u7684\u81ea\u5b9a\u4e49 Map \u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u5bf9\u4e8e\u5b8c\u5168\u63a7\u5236\u5e8f\u5217\u5316\u8fc7\u7a0b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"class FixedValueMap extends AbstractMap<String, Integer> {\n    private final Set<String> keys;\n    private final int fixedValue;\n\n    public FixedValueMap(Set<String> keys, int fixedValue) {\n        this.keys = keys;\n        this.fixedValue = fixedValue;\n    }\n\n    @Override\n    public Set<Entry<String, Integer>> entrySet() {\n        Set<Entry<String, Integer>> entries = new HashSet<>();\n        for (String key : keys) {\n            entries.add(new SimpleEntry<>(key, fixedValue));\n        }\n        return entries;\n    }\n\n    @Override\n    public Integer get(Object key) {\n        return keys.contains(key) ? fixedValue : null;\n    }\n\n    public Set<String> getKeys() {\n        return keys;\n    }\n\n    public int getFixedValue() {\n        return fixedValue;\n    }\n}\n\nclass FixedValueMapSerializer extends MapLikeSerializer<FixedValueMap> {\n    public FixedValueMapSerializer(Fory fory) {\n        // \u7981\u7528 codegen\uff0c\u56e0\u4e3a\u6211\u4eec\u76f4\u63a5\u5904\u7406\u5e8f\u5217\u5316\n        super(fory, FixedValueMap.class, false);\n    }\n\n    @Override\n    public void write(MemoryBuffer buffer, FixedValueMap value) {\n        // \u5199\u5165\u56fa\u5b9a\u503c\n        buffer.writeInt32(value.getFixedValue());\n        // \u5199\u5165\u952e\u7684\u6570\u91cf\n        buffer.writeVarUint32Small7(value.getKeys().size());\n        // \u5199\u5165\u6bcf\u4e2a\u952e\n        for (String key : value.getKeys()) {\n            buffer.writeString(key);\n        }\n    }\n\n    @Override\n    public FixedValueMap read(MemoryBuffer buffer) {\n        // \u8bfb\u53d6\u56fa\u5b9a\u503c\n        int fixedValue = buffer.readInt32();\n        // \u8bfb\u53d6\u952e\u7684\u6570\u91cf\n        int size = buffer.readVarUint32Small7();\n        Set<String> keys = new HashSet<>(size);\n        for (int i = 0; i < size; i++) {\n            keys.add(buffer.readString());\n        }\n        return new FixedValueMap(keys, fixedValue);\n    }\n\n    // \u5f53 supportCodegenHook \u4e3a false \u65f6\u4e0d\u4f7f\u7528\u8fd9\u4e9b\u65b9\u6cd5\n    @Override\n    public Map onMapWrite(MemoryBuffer buffer, FixedValueMap value) {\n        throw new UnsupportedOperationException();\n    }\n\n    @Override\n    public FixedValueMap onMapRead(Map map) {\n        throw new UnsupportedOperationException();\n    }\n\n    @Override\n    public FixedValueMap onMapCopy(Map map) {\n        throw new UnsupportedOperationException();\n    }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"\u7c7b-map-\u7c7b\u578b\u5e8f\u5217\u5316\u5668",children:"\u7c7b Map \u7c7b\u578b\u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsx)(n.p,{children:"\u5bf9\u4e8e\u884c\u4e3a\u7c7b\u4f3c map \u4f46\u4e0d\u662f\u6807\u51c6 Java Map \u7684\u7c7b\u578b\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'class CustomMapLike {\n    private final Object[] keyArray;\n    private final Object[] valueArray;\n    private final int size;\n\n    public CustomMapLike(int initialCapacity) {\n        this.keyArray = new Object[initialCapacity];\n        this.valueArray = new Object[initialCapacity];\n        this.size = 0;\n    }\n\n    public CustomMapLike(Object[] keyArray, Object[] valueArray, int size) {\n        this.keyArray = keyArray;\n        this.valueArray = valueArray;\n        this.size = size;\n    }\n\n    public Integer get(String key) {\n        for (int i = 0; i < size; i++) {\n            if (key.equals(keyArray[i])) {\n                return (Integer) valueArray[i];\n            }\n        }\n        return null;\n    }\n\n    public int size() {\n        return size;\n    }\n\n    public Object[] getKeyArray() {\n        return keyArray;\n    }\n\n    public Object[] getValueArray() {\n        return valueArray;\n    }\n}\n\nclass MapView extends AbstractMap<Object, Object> {\n    private final Object[] keyArray;\n    private final Object[] valueArray;\n    private final int size;\n    private int writeIndex;\n\n    public MapView(CustomMapLike mapLike) {\n        this.size = mapLike.size();\n        this.keyArray = mapLike.getKeyArray();\n        this.valueArray = mapLike.getValueArray();\n    }\n\n    public MapView(int size) {\n        this.size = size;\n        this.keyArray = new Object[size];\n        this.valueArray = new Object[size];\n    }\n\n    @Override\n    public Set<Entry<Object, Object>> entrySet() {\n        return new AbstractSet<Entry<Object, Object>>() {\n            @Override\n            public Iterator<Entry<Object, Object>> iterator() {\n                return new Iterator<Entry<Object, Object>>() {\n                    private int index = 0;\n\n                    @Override\n                    public boolean hasNext() {\n                        return index < size;\n                    }\n\n                    @Override\n                    public Entry<Object, Object> next() {\n                        if (!hasNext()) {\n                            throw new NoSuchElementException();\n                        }\n                        final int currentIndex = index++;\n                        return new SimpleEntry<>(\n                            keyArray[currentIndex],\n                            valueArray[currentIndex]\n                        );\n                    }\n                };\n            }\n\n            @Override\n            public int size() {\n                return size;\n            }\n        };\n    }\n\n    @Override\n    public Object put(Object key, Object value) {\n        if (writeIndex >= size) {\n            throw new IllegalStateException("Map is full");\n        }\n        keyArray[writeIndex] = key;\n        valueArray[writeIndex] = value;\n        writeIndex++;\n        return null;\n    }\n\n    public Object[] getKeyArray() {\n        return keyArray;\n    }\n\n    public Object[] getValueArray() {\n        return valueArray;\n    }\n\n    public int size() {\n        return size;\n    }\n}\n\nclass CustomMapLikeSerializer extends MapLikeSerializer<CustomMapLike> {\n    public CustomMapLikeSerializer(Fory fory) {\n        super(fory, CustomMapLike.class, true);\n    }\n\n    @Override\n    public Map onMapWrite(MemoryBuffer buffer, CustomMapLike value) {\n        buffer.writeVarUint32Small7(value.size());\n        return new MapView(value);\n    }\n\n    @Override\n    public Map newMap(MemoryBuffer buffer) {\n        int numElements = buffer.readVarUint32Small7();\n        setNumElements(numElements);\n        return new MapView(numElements);\n    }\n\n    @Override\n    public CustomMapLike onMapRead(Map map) {\n        MapView view = (MapView) map;\n        return new CustomMapLike(view.getKeyArray(), view.getValueArray(), view.size());\n    }\n\n    @Override\n    public CustomMapLike onMapCopy(Map map) {\n        MapView view = (MapView) map;\n        return new CustomMapLike(view.getKeyArray(), view.getValueArray(), view.size());\n    }\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u6ce8\u518c\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668",children:"\u6ce8\u518c\u81ea\u5b9a\u4e49\u5e8f\u5217\u5316\u5668"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"Fory fory = Fory.builder()\n    .withLanguage(Language.JAVA)\n    .build();\n\n// \u6ce8\u518c map \u5e8f\u5217\u5316\u5668\nfory.registerSerializer(CustomMap.class, new CustomMapSerializer<>(fory, CustomMap.class));\n\n// \u6ce8\u518c\u96c6\u5408\u5e8f\u5217\u5316\u5668\nfory.registerSerializer(CustomCollection.class, new CustomCollectionSerializer<>(fory, CustomCollection.class));\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5173\u952e\u70b9",children:"\u5173\u952e\u70b9"}),"\n",(0,r.jsx)(n.p,{children:"\u5b9e\u73b0\u81ea\u5b9a\u4e49 map \u6216\u96c6\u5408\u5e8f\u5217\u5316\u5668\u65f6\uff1a"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u59cb\u7ec8\u6269\u5c55\u9002\u5f53\u7684\u57fa\u7c7b\uff08map \u4f7f\u7528 ",(0,r.jsx)(n.code,{children:"MapSerializer"}),"/",(0,r.jsx)(n.code,{children:"MapLikeSerializer"}),"\uff0c\u96c6\u5408\u4f7f\u7528 ",(0,r.jsx)(n.code,{children:"CollectionSerializer"}),"/",(0,r.jsx)(n.code,{children:"CollectionLikeSerializer"}),"\uff09"]}),"\n",(0,r.jsxs)(n.li,{children:["\u8003\u8651 ",(0,r.jsx)(n.code,{children:"supportCodegenHook"})," \u5bf9\u6027\u80fd\u548c\u529f\u80fd\u7684\u5f71\u54cd"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u9700\u8981\uff0c\u9002\u5f53\u5904\u7406\u5f15\u7528\u8ddf\u8e2a"}),"\n",(0,r.jsxs)(n.li,{children:["\u5f53 ",(0,r.jsx)(n.code,{children:"supportCodegenHook"})," \u4e3a ",(0,r.jsx)(n.code,{children:"true"})," \u65f6\uff0c\u4f7f\u7528 ",(0,r.jsx)(n.code,{children:"setNumElements"})," \u548c ",(0,r.jsx)(n.code,{children:"getAndClearNumElements"})," \u5b9e\u73b0\u9002\u5f53\u7684\u5927\u5c0f\u7ba1\u7406"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u76f8\u5173\u4e3b\u9898",children:"\u76f8\u5173\u4e3b\u9898"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/zh-CN/docs/0.14/guide/java/type_registration",children:"\u7c7b\u578b\u6ce8\u518c"})," - \u6ce8\u518c\u5e8f\u5217\u5316\u5668"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/zh-CN/docs/0.14/guide/java/schema_evolution",children:"Schema \u6f14\u5316"})," - \u517c\u5bb9\u6a21\u5f0f\u8003\u8651"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/zh-CN/docs/0.14/guide/java/configuration",children:"\u914d\u7f6e\u9009\u9879"})," - \u5e8f\u5217\u5316\u9009\u9879"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},11151:(e,n,i)=>{i.d(n,{Z:()=>a,a:()=>s});var r=i(67294);const t={},l=r.createContext(t);function s(e){const n=r.useContext(l);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);