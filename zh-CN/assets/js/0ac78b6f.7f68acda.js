"use strict";(self.webpackChunkfory_site=self.webpackChunkfory_site||[]).push([[75822],{45573:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>r,default:()=>x,frontMatter:()=>d,metadata:()=>c,toc:()=>a});var s=i(85893),l=i(11151);const d={title:"Java \u5e8f\u5217\u5316\u683c\u5f0f",sidebar_position:1,id:"java_serialization_spec",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance\nwith the License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},r=void 0,c={id:"specification/java_serialization_spec",title:"Java \u5e8f\u5217\u5316\u683c\u5f0f",description:"\u672c\u6587\u5b9a\u4e49 Apache Fory Java \u539f\u751f\u5e8f\u5217\u5316\u683c\u5f0f\u7684\u7f16\u7801\u683c\u5f0f\u7ec6\u8282\u3002",source:"@site/i18n/zh-CN/docusaurus-plugin-content-docs/current/specification/java_serialization_spec.md",sourceDirName:"specification",slug:"/specification/java_serialization_spec",permalink:"/zh-CN/docs/next/specification/java_serialization_spec",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/fory-site/tree/main/i18n/zh-CN/docusaurus-plugin-content-docs/current/specification/java_serialization_spec.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Java \u5e8f\u5217\u5316\u683c\u5f0f",sidebar_position:1,id:"java_serialization_spec",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance\nwith the License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},sidebar:"specificationSidebar",next:{title:"Row \u683c\u5f0f",permalink:"/zh-CN/docs/next/specification/row_format_spec"}},t={},a=[{value:"\u89c4\u8303\u6982\u89c8",id:"\u89c4\u8303\u6982\u89c8",level:2},{value:"Fory \u5934\u90e8",id:"fory-\u5934\u90e8",level:2},{value:"\u5f15\u7528\u5143\u4fe1\u606f",id:"\u5f15\u7528\u5143\u4fe1\u606f",level:2},{value:"Type system and type IDs",id:"type-system-and-type-ids",level:2},{value:"Shared internal type IDs (0-63)",id:"shared-internal-type-ids-0-63",level:3},{value:"Java native built-in type IDs",id:"java-native-built-in-type-ids",level:3},{value:"Registration and named types",id:"registration-and-named-types",level:3},{value:"Type meta encoding",id:"type-meta-encoding",level:2},{value:"Shared class meta (streaming)",id:"shared-class-meta-streaming",level:3},{value:"Schema modes",id:"schema-modes",level:2},{value:"ClassDef format (compatible mode)",id:"classdef-format-compatible-mode",level:2},{value:"Binary layout",id:"binary-layout",level:3},{value:"Class meta bytes",id:"class-meta-bytes",level:3},{value:"Field info",id:"field-info",level:3},{value:"Field type encoding",id:"field-type-encoding",level:3},{value:"Meta string encoding",id:"meta-string-encoding",level:2},{value:"Package and type names",id:"package-and-type-names",level:3},{value:"Field names",id:"field-names",level:3},{value:"Encoding algorithms",id:"encoding-algorithms",level:3},{value:"Value encodings",id:"value-encodings",level:2},{value:"Primitives",id:"primitives",level:3},{value:"String",id:"string",level:3},{value:"Enum",id:"enum",level:3},{value:"Binary (byte[])",id:"binary-byte",level:3},{value:"Primitive arrays",id:"primitive-arrays",level:3},{value:"Object arrays",id:"object-arrays",level:3},{value:"Collections (List/Set)",id:"collections-listset",level:3},{value:"Maps",id:"maps",level:3},{value:"Null key/value entries",id:"null-keyvalue-entries",level:4},{value:"Objects and structs",id:"objects-and-structs",level:3},{value:"Extensions (EXT)",id:"extensions-ext",level:3},{value:"Out-of-band buffers",id:"out-of-band-buffers",level:2}];function h(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"\u672c\u6587\u5b9a\u4e49 Apache Fory Java \u539f\u751f\u5e8f\u5217\u5316\u683c\u5f0f\u7684\u7f16\u7801\u683c\u5f0f\u7ec6\u8282\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u89c4\u8303\u6982\u89c8",children:"\u89c4\u8303\u6982\u89c8"}),"\n",(0,s.jsx)(n.p,{children:"Fory Java \u539f\u751f\u683c\u5f0f\u9762\u5411 Java \u5bf9\u8c61\u56fe\uff0c\u652f\u6301\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5171\u4eab\u5f15\u7528\u4e0e\u5faa\u73af\u5f15\u7528"}),"\n",(0,s.jsx)(n.li,{children:"\u591a\u6001\u5bf9\u8c61"}),"\n",(0,s.jsx)(n.li,{children:"\u53ef\u9009 schema \u6f14\u8fdb"}),"\n",(0,s.jsx)(n.li,{children:"\u6d41\u5f0f\u5199\u5165\uff08\u5171\u4eab type meta \u6309\u9700\u5185\u8054\uff0c\u4e0d\u8981\u6c42\u9884\u5148 meta \u533a\uff09"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Java native \u662f xlang \u7f16\u7801\u683c\u5f0f\u7684\u6269\u5c55\uff0c\u590d\u7528\u76f8\u540c\u6838\u5fc3\u5e27\u4e0e\u57fa\u7840\u7f16\u7801\u3002"}),"\n",(0,s.jsx)(n.p,{children:"\u603b\u4f53\u5e03\u5c40\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| fory header | object ref meta | object type meta | object value data |\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u5b57\u8282\u5e8f\u7edf\u4e00\u4e3a little-endian\u3002\u5927\u7aef\u5e73\u53f0\u5b9e\u73b0\u9700\u5728\u6570\u7ec4\u7b49\u8def\u5f84\u505a\u5b57\u8282\u5e8f\u8f6c\u6362\uff0c\u786e\u4fdd\u7ebf\u4e0a\u683c\u5f0f\u4e00\u81f4\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"fory-\u5934\u90e8",children:"Fory \u5934\u90e8"}),"\n",(0,s.jsx)(n.p,{children:"Java \u539f\u751f\u5e8f\u5217\u5316\u5934\u90e8\u662f 1-byte \u4f4d\u56fe\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"|     5 bits    | 1 bit | 1 bit | 1 bit |\n+--------------+-------+-------+-------+\n| reserved     |  oob  | xlang | null  |\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u542b\u4e49\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"null"}),"\uff1a\u5bf9\u8c61\u662f\u5426\u4e3a null\uff08\u4e3a 1 \u65f6\u5176\u4f59\u4f4d\u4e0d\u5e94\u7f6e\u4f4d\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"xlang"}),"\uff1a1 \u8868\u793a xlang \u683c\u5f0f\uff0c0 \u8868\u793a Java native"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"oob"}),"\uff1a1 \u8868\u793a\u5b58\u5728 ",(0,s.jsx)(n.code,{children:"BufferCallback"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u5934\u90e8\u59cb\u7ec8 1 \u5b57\u8282\uff0c\u4e0d\u989d\u5916\u5199 language ID\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u5f15\u7528\u5143\u4fe1\u606f",children:"\u5f15\u7528\u5143\u4fe1\u606f"}),"\n",(0,s.jsx)(n.p,{children:"\u5f15\u7528\u8ddf\u8e2a\u6807\u8bb0\u4e0e xlang \u4e00\u81f4\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u6807\u8bb0"}),(0,s.jsx)(n.th,{children:"\u5b57\u8282\u503c"}),(0,s.jsx)(n.th,{children:"\u8bf4\u660e"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"NULL FLAG"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"-3"})}),(0,s.jsx)(n.td,{children:"\u5bf9\u8c61\u4e3a null\uff0c\u540e\u7eed\u4e0d\u5199\u5bf9\u8c61\u5185\u5bb9"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"REF FLAG"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"-2"})}),(0,s.jsxs)(n.td,{children:["\u5df2\u51fa\u73b0\u5bf9\u8c61\uff0c\u540e\u63a5 ",(0,s.jsx)(n.code,{children:"varuint32"})," \u7684 reference ID"]})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"NOT_NULL VALUE FLAG"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"-1"})}),(0,s.jsx)(n.td,{children:"\u975e\u7a7a\u4f46\u8be5\u7c7b\u578b\u672a\u542f\u7528\u5f15\u7528\u8ddf\u8e2a\uff0c\u540e\u63a5\u5bf9\u8c61\u5185\u5bb9"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"REF VALUE FLAG"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"0"})}),(0,s.jsx)(n.td,{children:"\u53ef\u5f15\u7528\u5bf9\u8c61\u9996\u6b21\u51fa\u73b0\uff0c\u540e\u63a5\u5bf9\u8c61\u5185\u5bb9\uff0c\u5e76\u5206\u914d\u65b0 reference ID"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u5f53\u5168\u5c40\u6216\u5b57\u6bb5\u7ea7\u7981\u7528\u5f15\u7528\u8ddf\u8e2a\u65f6\uff0c\u4ec5\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"NULL FLAG"})," \u4e0e ",(0,s.jsx)(n.code,{children:"NOT_NULL VALUE FLAG"}),"\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"type-system-and-type-ids",children:"Type system and type IDs"}),"\n",(0,s.jsx)(n.p,{children:"Java native \u4f7f\u7528\u4e0e xlang \u7edf\u4e00\u7684\u7c7b\u578b ID \u7ec4\u5408\u65b9\u5f0f\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"full_type_id = (user_type_id << 8) | internal_type_id\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"internal_type_id"}),"\uff1a\u4f4e 8 \u4f4d\uff0c\u8868\u793a\u7c7b\u578b\u79cd\u7c7b"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"user_type_id"}),"\uff1a\u7528\u6237\u6ce8\u518c\u6570\u503c ID\uff08\u9002\u7528\u4e8e\u7528\u6237 enum/struct/ext\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:["named \u7c7b\u578b\u4f7f\u7528 ",(0,s.jsx)(n.code,{children:"NAMED_*"}),"\uff0c\u5176\u6807\u8bc6\u6765\u81ea\u5143\u4fe1\u606f\uff08\u547d\u540d\u7a7a\u95f4+\u7c7b\u578b\u540d\uff09"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"shared-internal-type-ids-0-63",children:"Shared internal type IDs (0-63)"}),"\n",(0,s.jsxs)(n.p,{children:["Java native \u4e0e xlang \u5171\u4eab ",(0,s.jsx)(n.code,{children:"< 64"})," \u7684 internal IDs\uff1a"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"0~56"})," \u5df2\u5b9a\u4e49"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"57~63"})," \u9884\u7559"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["\u8be6\u89c1 ",(0,s.jsx)(n.a,{href:"/zh-CN/docs/next/specification/xlang_serialization_spec#internal-type-id-table",children:"Xlang Serialization Format"}),"\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"java-native-built-in-type-ids",children:"Java native built-in type IDs"}),"\n",(0,s.jsxs)(n.p,{children:["Java \u4e13\u6709\u5185\u5efa\u7c7b\u578b\u4ece ",(0,s.jsx)(n.code,{children:"Types.BOUND + 5"})," \u5f00\u59cb\uff08",(0,s.jsx)(n.code,{children:"Types.BOUND=64"}),"\uff0c\u9884\u7559 5 \u4e2a\uff09\u3002"]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type ID"}),(0,s.jsx)(n.th,{children:"Name"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"69"}),(0,s.jsx)(n.td,{children:"VOID_ID"}),(0,s.jsx)(n.td,{children:"java.lang.Void"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"70"}),(0,s.jsx)(n.td,{children:"CHAR_ID"}),(0,s.jsx)(n.td,{children:"java.lang.Character"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"71"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_VOID_ID"}),(0,s.jsx)(n.td,{children:"void"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"72"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_BOOL_ID"}),(0,s.jsx)(n.td,{children:"boolean"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"73"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_INT8_ID"}),(0,s.jsx)(n.td,{children:"byte"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"74"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_CHAR_ID"}),(0,s.jsx)(n.td,{children:"char"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"75"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_INT16_ID"}),(0,s.jsx)(n.td,{children:"short"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"76"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_INT32_ID"}),(0,s.jsx)(n.td,{children:"int"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"77"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_FLOAT32_ID"}),(0,s.jsx)(n.td,{children:"float"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"78"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_INT64_ID"}),(0,s.jsx)(n.td,{children:"long"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"79"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_FLOAT64_ID"}),(0,s.jsx)(n.td,{children:"double"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"80"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_BOOLEAN_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"boolean[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"81"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_BYTE_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"byte[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"82"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_CHAR_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"char[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"83"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_SHORT_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"short[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"84"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_INT_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"int[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"85"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_FLOAT_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"float[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"86"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_LONG_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"long[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"87"}),(0,s.jsx)(n.td,{children:"PRIMITIVE_DOUBLE_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"double[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"88"}),(0,s.jsx)(n.td,{children:"STRING_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"String[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"89"}),(0,s.jsx)(n.td,{children:"OBJECT_ARRAY_ID"}),(0,s.jsx)(n.td,{children:"Object[]"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"90"}),(0,s.jsx)(n.td,{children:"ARRAYLIST_ID"}),(0,s.jsx)(n.td,{children:"java.util.ArrayList"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"91"}),(0,s.jsx)(n.td,{children:"HASHMAP_ID"}),(0,s.jsx)(n.td,{children:"java.util.HashMap"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"92"}),(0,s.jsx)(n.td,{children:"HASHSET_ID"}),(0,s.jsx)(n.td,{children:"java.util.HashSet"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"93"}),(0,s.jsx)(n.td,{children:"CLASS_ID"}),(0,s.jsx)(n.td,{children:"java.lang.Class"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"94"}),(0,s.jsx)(n.td,{children:"EMPTY_OBJECT_ID"}),(0,s.jsx)(n.td,{children:"empty object stub"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"95"}),(0,s.jsx)(n.td,{children:"LAMBDA_STUB_ID"}),(0,s.jsx)(n.td,{children:"lambda stub"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"96"}),(0,s.jsx)(n.td,{children:"JDK_PROXY_STUB_ID"}),(0,s.jsx)(n.td,{children:"JDK proxy stub"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"97"}),(0,s.jsx)(n.td,{children:"REPLACE_STUB_ID"}),(0,s.jsx)(n.td,{children:"writeReplace/readResolve stub"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"98"}),(0,s.jsx)(n.td,{children:"NONEXISTENT_META_SHARED_ID"}),(0,s.jsx)(n.td,{children:"meta-shared unknown class stub"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"registration-and-named-types",children:"Registration and named types"}),"\n",(0,s.jsx)(n.p,{children:"\u7528\u6237\u7c7b\u578b\u53ef\u6309\u6570\u503c\u6216\u540d\u79f0\u6ce8\u518c\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u6570\u503c\u6ce8\u518c\uff1a",(0,s.jsx)(n.code,{children:"full_type_id = (user_id << 8) | internal_type_id"})]}),"\n",(0,s.jsx)(n.li,{children:"\u540d\u79f0\u6ce8\u518c\uff1a\u901a\u8fc7 namespace + typename"}),"\n",(0,s.jsx)(n.li,{children:"\u672a\u6ce8\u518c\u7c7b\u578b\u6309 named \u7c7b\u578b\u5199\u51fa\uff08namespace=\u5305\u540d\uff0ctypename=\u7c7b\u540d\uff09"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u672a\u6ce8\u518c\u65f6\u547d\u540d\u7c7b\u578b\u9009\u62e9\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["enum -> ",(0,s.jsx)(n.code,{children:"NAMED_ENUM"})]}),"\n",(0,s.jsxs)(n.li,{children:["struct-like -> ",(0,s.jsx)(n.code,{children:"NAMED_STRUCT"}),"\uff08\u517c\u5bb9\u6a21\u5f0f\u4e0b ",(0,s.jsx)(n.code,{children:"NAMED_COMPATIBLE_STRUCT"}),"\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:["\u5176\u4ed6\u81ea\u5b9a\u4e49 serializer -> ",(0,s.jsx)(n.code,{children:"NAMED_EXT"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"type-meta-encoding",children:"Type meta encoding"}),"\n",(0,s.jsx)(n.p,{children:"\u6bcf\u4e2a\u503c\u5199\u5165\u6d41\u7a0b\uff1a"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\u5199 ",(0,s.jsx)(n.code,{children:"type_id"}),"\uff08varuint32 small7\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:["\u5bf9 ",(0,s.jsx)(n.code,{children:"NAMED_*"})," / ",(0,s.jsx)(n.code,{children:"COMPATIBLE_STRUCT"})," \u7b49\u7c7b\u578b\u6309\u89c4\u5219\u5199\u989d\u5916\u5143\u4fe1\u606f"]}),"\n",(0,s.jsx)(n.li,{children:"\u5176\u4f59\u7c7b\u578b\u65e0\u9700\u989d\u5916 meta"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"shared-class-meta-streaming",children:"Shared class meta (streaming)"}),"\n",(0,s.jsx)(n.p,{children:"\u5f00\u542f meta share \u65f6\uff0c\u4f7f\u7528\u6d41\u5f0f\u5171\u4eab class meta\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| varuint32: index_marker | [class def bytes if new] |\n\nindex_marker = (index << 1) | flag\nflag = 1 -> reference\nflag = 0 -> new type\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"flag=1"}),"\uff1a\u5f15\u7528\u5386\u53f2 type\uff0c\u540e\u7eed\u65e0 class def bytes"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"flag=0"}),"\uff1a\u65b0 type\uff0c\u540e\u7eed\u5185\u8054 class def"]}),"\n",(0,s.jsx)(n.li,{children:"index \u6309\u9996\u6b21\u51fa\u73b0\u987a\u5e8f\u9012\u589e"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"schema-modes",children:"Schema modes"}),"\n",(0,s.jsx)(n.p,{children:"Java native \u652f\u6301\u4e24\u79cd\u6a21\u5f0f\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Schema consistent"}),"\uff08compatible \u5173\u95ed\uff09\uff1a\u5b57\u6bb5\u6309\u56fa\u5b9a\u987a\u5e8f\u5199\uff0c\u4e0d\u9700\u8981 ClassDef"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Schema evolution"}),"\uff08compatible \u5f00\u542f\uff09\uff1a\u6309 ClassDef \u5143\u4fe1\u606f\u652f\u6301\u6f14\u8fdb"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"classdef-format-compatible-mode",children:"ClassDef format (compatible mode)"}),"\n",(0,s.jsx)(n.p,{children:"ClassDef \u662f compatible struct \u7684\u6f14\u8fdb\u5143\u4fe1\u606f\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"binary-layout",children:"Binary layout"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| 8 bytes header | [varuint32 extra size] | class meta bytes |\n"})}),"\n",(0,s.jsx)(n.p,{children:"header \u4f4d\u5e03\u5c40\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| 50-bit hash | 4 bits reserved | 1 bit compress | 1 bit has_fields_meta | 8-bit size |\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u89c4\u5219\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"size"})," \u4e3a\u4f4e 8 \u4f4d\uff1b\u82e5\u4e3a ",(0,s.jsx)(n.code,{children:"0xFF"}),"\uff0c\u540e\u63a5\u6269\u5c55\u957f\u5ea6"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"compress"}),"\uff1apayload \u662f\u5426\u538b\u7f29"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"has_fields_meta"}),"\uff1a\u662f\u5426\u542b\u5b57\u6bb5\u5143\u4fe1\u606f"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"reserved"})," \u5fc5\u987b\u4e3a 0"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"hash"})," \u4e3a payload + flags \u7684 50-bit \u54c8\u5e0c"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"class-meta-bytes",children:"Class meta bytes"}),"\n",(0,s.jsx)(n.p,{children:"\u8868\u793a\u7ebf\u6027\u5316\u7ee7\u627f\u5c42\u6b21\uff08\u7236 -> \u5b50\uff09\u4e0e\u5b57\u6bb5\u4fe1\u606f\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| num_classes | class_layer_0 | class_layer_1 | ... |\n\nclass_layer:\n| num_fields << 1 | registered_flag | [type_id if registered] |\n| namespace | type_name | field_infos |\n"})}),"\n",(0,s.jsx)(n.h3,{id:"field-info",children:"Field info"}),"\n",(0,s.jsx)(n.p,{children:"\u6bcf\u4e2a\u5b57\u6bb5\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| field_header | [field_name_bytes] | field_type |\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"field_header"}),"\uff1a"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"bit0: trackingRef"}),"\n",(0,s.jsx)(n.li,{children:"bit1: nullable"}),"\n",(0,s.jsx)(n.li,{children:"bit2-3: \u5b57\u6bb5\u540d\u7f16\u7801"}),"\n",(0,s.jsx)(n.li,{children:"bit4-6: name length/tag ID\uff087 \u8868\u793a\u6269\u5c55\uff09"}),"\n",(0,s.jsx)(n.li,{children:"bit7: reserved=0"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u5b57\u6bb5\u540d\u7f16\u7801\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"0: UTF8"}),"\n",(0,s.jsx)(n.li,{children:"1: ALL_TO_LOWER_SPECIAL"}),"\n",(0,s.jsx)(n.li,{children:"2: LOWER_UPPER_DIGIT_SPECIAL"}),"\n",(0,s.jsx)(n.li,{children:"3: TAG_ID\uff08\u7701\u7565\u5b57\u6bb5\u540d\uff0c\u5b58 tag\uff09"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"field-type-encoding",children:"Field type encoding"}),"\n",(0,s.jsx)(n.p,{children:"\u5b57\u6bb5\u7c7b\u578b\u4f7f\u7528 type tag + \u53ef\u9009\u5d4c\u5957\u7c7b\u578b\u4fe1\u606f\uff1a"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Tag"}),(0,s.jsx)(n.th,{children:"\u5b57\u6bb5\u7c7b\u578b"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"0"}),(0,s.jsx)(n.td,{children:"Object (ObjectFieldType)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"1"}),(0,s.jsx)(n.td,{children:"Map (MapFieldType)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"2"}),(0,s.jsx)(n.td,{children:"Collection/List/Set (CollectionFieldType)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"3"}),(0,s.jsx)(n.td,{children:"Array (ArrayFieldType)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"4"}),(0,s.jsx)(n.td,{children:"Enum (EnumFieldType)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"5+"}),(0,s.jsx)(n.td,{children:"Registered type (RegisteredFieldType)"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["\u5d4c\u5957\u7c7b\u578b\u5934\u90e8\u4f4e\u4f4d\u53ef\u643a\u5e26 ",(0,s.jsx)(n.code,{children:"nullable/tracking_ref"})," \u6807\u5fd7\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"meta-string-encoding",children:"Meta string encoding"}),"\n",(0,s.jsx)(n.p,{children:"namespace\u3001type name\u3001field name \u590d\u7528 xlang \u7684 meta string \u7f16\u7801\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"package-and-type-names",children:"Package and type names"}),"\n",(0,s.jsx)(n.p,{children:"\u5934\u90e8\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| 6 bits size | 2 bits encoding |\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"size=63"})," \u65f6\u8ffd\u52a0\u6269\u5c55\u957f\u5ea6"]}),"\n",(0,s.jsx)(n.li,{children:"package \u652f\u6301\uff1aUTF8 / ALL_TO_LOWER_SPECIAL / LOWER_UPPER_DIGIT_SPECIAL"}),"\n",(0,s.jsx)(n.li,{children:"type name \u652f\u6301\uff1aUTF8 / LOWER_UPPER_DIGIT_SPECIAL / FIRST_TO_LOWER_SPECIAL / ALL_TO_LOWER_SPECIAL"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"field-names",children:"Field names"}),"\n",(0,s.jsx)(n.p,{children:"\u5b57\u6bb5\u540d\u7f16\u7801\u4e0e ClassDef \u7684 field header \u89c4\u5219\u4e00\u81f4\uff1b\u82e5\u4f7f\u7528 TAG_ID\uff0c\u5219\u4e0d\u5199\u540d\u5b57\u5b57\u8282\u3002"}),"\n",(0,s.jsx)(n.h3,{id:"encoding-algorithms",children:"Encoding algorithms"}),"\n",(0,s.jsxs)(n.p,{children:["\u5177\u4f53\u7b97\u6cd5\u53c2\u89c1 xlang \u89c4\u8303 ",(0,s.jsx)(n.code,{children:"#meta-string"}),"\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"value-encodings",children:"Value encodings"}),"\n",(0,s.jsxs)(n.p,{children:["\u4ee5\u4e0b\u4e3a Java native \u5e38\u89c1\u5185\u5efa serializer \u7684\u503c\u5e03\u5c40\u3002\u81ea\u5b9a\u4e49 ",(0,s.jsx)(n.code,{children:"EXT"})," \u53ef\u5b9a\u4e49\u81ea\u8eab\u503c\u683c\u5f0f\uff0c\u4f46\u5fc5\u987b\u9075\u5faa\u201c\u5f15\u7528\u5143\u4fe1\u606f + \u7c7b\u578b\u5143\u4fe1\u606f\u201d\u901a\u9053\u89c4\u5219\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"primitives",children:"Primitives"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"boolean: 1 byte\uff080/1\uff09"}),"\n",(0,s.jsx)(n.li,{children:"byte: 1 byte"}),"\n",(0,s.jsx)(n.li,{children:"short: 2 bytes little-endian"}),"\n",(0,s.jsx)(n.li,{children:"char: 2 bytes little-endian\uff08UTF-16 code unit\uff09"}),"\n",(0,s.jsx)(n.li,{children:"int: fixed(4 bytes) \u6216 varint32(ZigZag)"}),"\n",(0,s.jsx)(n.li,{children:"long: fixed(8 bytes) / varint64(ZigZag) / tagged int64"}),"\n",(0,s.jsx)(n.li,{children:"float: IEEE754 float32"}),"\n",(0,s.jsx)(n.li,{children:"double: IEEE754 float64"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"string",children:"String"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| varuint36_small: (num_bytes << 2) | coder | string bytes |\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"coder(2 bits)\uff1aLATIN1 / UTF16 / UTF8"}),"\n",(0,s.jsx)(n.li,{children:"UTF16 \u91c7\u7528 little-endian code unit"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"enum",children:"Enum"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"serializeEnumByName=true"}),"\uff1a\u5199 enum \u540d\u79f0\uff08meta string\uff09"]}),"\n",(0,s.jsx)(n.li,{children:"\u5426\u5219\uff1a\u5199 ordinal\uff08varuint32 small7\uff09"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"binary-byte",children:"Binary (byte[])"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| varuint32: num_bytes | raw bytes |\n"})}),"\n",(0,s.jsx)(n.h3,{id:"primitive-arrays",children:"Primitive arrays"}),"\n",(0,s.jsx)(n.p,{children:"\u9ed8\u8ba4\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| varuint32: byte_length | raw bytes |\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u53ef\u9009\u538b\u7f29\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"compressIntArray"}),"\uff1a",(0,s.jsx)(n.code,{children:"| length | varint32... |"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"compressLongArray"}),"\uff1a",(0,s.jsx)(n.code,{children:"| length | varint64/tagged... |"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"object-arrays",children:"Object arrays"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| varuint32_small7: (length << 1) | mono_flag |\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"mono_flag=1"}),"\uff1a\u5355\u6001\u6570\u7ec4\uff0c\u5171\u4eab\u7ec4\u4ef6 serializer"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"mono_flag=0"}),"\uff1a\u6bcf\u5143\u7d20\u72ec\u7acb class info + data"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"collections-listset",children:"Collections (List/Set)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| varuint32_small7: length | elements_header | [elem_class_info] | elements... |\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"elements_header"}),"\uff1a"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"bit0: TRACKING_REF"}),"\n",(0,s.jsx)(n.li,{children:"bit1: HAS_NULL"}),"\n",(0,s.jsx)(n.li,{children:"bit2: IS_DECL_ELEMENT_TYPE"}),"\n",(0,s.jsx)(n.li,{children:"bit3: IS_SAME_TYPE"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"maps",children:"Maps"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| varuint32_small7: size | chunk_1 | chunk_2 | ... |\n\nchunk:\n| header | chunk_size | [key_class_info] | [value_class_info] | entries... |\n"})}),"\n",(0,s.jsx)(n.p,{children:"Map \u91c7\u7528 chunk \u7f16\u7801\uff0c\u6bcf\u5757\u6700\u591a 255 entries\uff1bkey/value \u7684\u5f15\u7528\u8ddf\u8e2a\u4e0e\u7c7b\u578b\u58f0\u660e\u6309 header \u4f4d\u56fe\u63a7\u5236\u3002"}),"\n",(0,s.jsx)(n.h4,{id:"null-keyvalue-entries",children:"Null key/value entries"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"null key"})," \u6216 ",(0,s.jsx)(n.code,{children:"null value"})," \u4f7f\u7528\u7279\u6b8a\u5355\u6761 chunk\uff0c\u4e0d\u5199 ",(0,s.jsx)(n.code,{children:"chunk_size"}),"\uff0c\u53ea\u5199\u5bf9\u5e94 payload\u3002"]}),"\n",(0,s.jsx)(n.h3,{id:"objects-and-structs",children:"Objects and structs"}),"\n",(0,s.jsx)(n.p,{children:"\u5bf9\u8c61\u503c\u901a\u9053\uff1a"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"| ref meta | type meta | field data |\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u6807\u51c6\u5bf9\u8c61\u5e8f\u5217\u5316\u4e2d\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u5b57\u6bb5\u6309\u7a33\u5b9a\u987a\u5e8f\uff08DescriptorGrouper\uff09\u6392\u5e8f"}),"\n",(0,s.jsx)(n.li,{children:"compatible \u6a21\u5f0f\u53ef\u501f\u52a9 ClassDef \u6620\u5c04\u5b57\u6bb5\u5e76\u8df3\u8fc7\u672a\u77e5\u5b57\u6bb5"}),"\n",(0,s.jsx)(n.li,{children:"\u5b57\u6bb5\u662f\u5426\u5199 ref/type meta \u7531 nullable/ref/polymorphic \u7b56\u7565\u51b3\u5b9a"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"extensions-ext",children:"Extensions (EXT)"}),"\n",(0,s.jsx)(n.p,{children:"EXT \u7c7b\u578b\u503c\u7531\u6ce8\u518c serializer \u5b9a\u4e49\uff1b\u4f46\u5176\u5916\u5c42\u4ecd\u9075\u5faa\u7edf\u4e00\u7684\u5f15\u7528\u4e0e\u7c7b\u578b\u5143\u4fe1\u606f\u534f\u8bae\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"out-of-band-buffers",children:"Out-of-band buffers"}),"\n",(0,s.jsxs)(n.p,{children:["\u5f53\u63d0\u4f9b ",(0,s.jsx)(n.code,{children:"BufferCallback"})," \u65f6\uff0cheader \u7684 ",(0,s.jsx)(n.code,{children:"oob"})," \u4f4d\u7f6e 1\u3002\u6b64\u65f6 serializer \u53ef\u8f93\u51fa\u201c\u7f13\u51b2\u533a\u5f15\u7528\u201d\u800c\u975e\u5185\u8054\u5b57\u8282\uff08\u5982\u5927\u6570\u7ec4\uff09\u3002\n\u4e3b\u6d41\u4e2d\u4ec5\u4fdd\u7559\u5f15\u7528\u4fe1\u606f\uff0c\u5177\u4f53 OOB \u7f13\u51b2\u533a\u534f\u8bae\u7531 callback \u5b9e\u73b0\u5b9a\u4e49\u3002"]})]})}function x(e={}){const{wrapper:n}={...(0,l.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},11151:(e,n,i)=>{i.d(n,{Z:()=>c,a:()=>r});var s=i(67294);const l={},d=s.createContext(l);function r(e){const n=s.useContext(d);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),s.createElement(d.Provider,{value:n},e.children)}}}]);