"use strict";(self.webpackChunkfory_site=self.webpackChunkfory_site||[]).push([[66799],{89851:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>d});var i=r(85893),s=r(11151);const t={title:"\u5f15\u7528\u8ddf\u8e2a",sidebar_position:45,id:"reference_tracking",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},l=void 0,a={id:"guide/xlang/reference_tracking",title:"\u5f15\u7528\u8ddf\u8e2a",description:"\u672c\u9875\u8bf4\u660e Fory \u5728\u8de8\u8bed\u8a00\u5e8f\u5217\u5316\u4e2d\u5982\u4f55\u5904\u7406\u5171\u4eab\u5f15\u7528\u4e0e\u5faa\u73af\u5f15\u7528\u7684\u5f15\u7528\u8ddf\u8e2a\u3002",source:"@site/i18n/zh-CN/docusaurus-plugin-content-docs/version-0.15/guide/xlang/field-reference-tracking.md",sourceDirName:"guide/xlang",slug:"/guide/xlang/reference_tracking",permalink:"/zh-CN/docs/guide/xlang/reference_tracking",draft:!1,unlisted:!1,editUrl:"https://github.com/apache/fory-site/tree/main/i18n/zh-CN/docusaurus-plugin-content-docs/version-0.15/guide/xlang/field-reference-tracking.md",tags:[],version:"0.15",sidebarPosition:45,frontMatter:{title:"\u5f15\u7528\u8ddf\u8e2a",sidebar_position:45,id:"reference_tracking",license:'Licensed to the Apache Software Foundation (ASF) under one or more\ncontributor license agreements.  See the NOTICE file distributed with\nthis work for additional information regarding copyright ownership.\nThe ASF licenses this file to You under the Apache License, Version 2.0\n(the "License"); you may not use this file except in compliance with\nthe License.  You may obtain a copy of the License at\n\n   http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an "AS IS" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n'},sidebar:"docsSidebar",previous:{title:"\u5b57\u6bb5\u53ef\u7a7a\u6027",permalink:"/zh-CN/docs/guide/xlang/field_nullability"},next:{title:"\u5b57\u6bb5\u7c7b\u578b\u5143\u4fe1\u606f",permalink:"/zh-CN/docs/guide/xlang/field_type_meta"}},c={},d=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u542f\u7528\u5f15\u7528\u8ddf\u8e2a",id:"\u542f\u7528\u5f15\u7528\u8ddf\u8e2a",level:2},{value:"Java",id:"java",level:3},{value:"Python",id:"python",level:3},{value:"Go",id:"go",level:3},{value:"C++",id:"c",level:3},{value:"Rust",id:"rust",level:3},{value:"\u7ebf\u683c\u5f0f",id:"\u7ebf\u683c\u5f0f",level:2},{value:"\u5f15\u7528\u8ddf\u8e2a\u4e0e\u53ef\u7a7a\u6027",id:"\u5f15\u7528\u8ddf\u8e2a\u4e0e\u53ef\u7a7a\u6027",level:2},{value:"Per-Field Reference Tracking",id:"per-field-reference-tracking",level:2},{value:"\u9ed8\u8ba4\u884c\u4e3a by Language",id:"\u9ed8\u8ba4\u884c\u4e3a-by-language",level:3},{value:"Customizing Per-Field Ref Tracking",id:"customizing-per-field-ref-tracking",level:3},{value:"Java: @ForyField Annotation",id:"java-foryfield-annotation",level:4},{value:"C++: fory::field Wrapper",id:"c-foryfield-wrapper",level:4},{value:"Rust: Field Attributes",id:"rust-field-attributes",level:4},{value:"Go: Struct Tags",id:"go-struct-tags",level:4},{value:"When to Enable Per-Field Ref Tracking",id:"when-to-enable-per-field-ref-tracking",level:3},{value:"Example: Shared References",id:"example-shared-references",level:2},{value:"Example: Circular References",id:"example-circular-references",level:2},{value:"Language Support",id:"language-support",level:2},{value:"Performance Considerations",id:"performance-considerations",level:2},{value:"See Also",id:"see-also",level:2}];function o(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"\u672c\u9875\u8bf4\u660e Fory \u5728\u8de8\u8bed\u8a00\u5e8f\u5217\u5316\u4e2d\u5982\u4f55\u5904\u7406\u5171\u4eab\u5f15\u7528\u4e0e\u5faa\u73af\u5f15\u7528\u7684\u5f15\u7528\u8ddf\u8e2a\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,i.jsx)(n.p,{children:"Reference tracking enables:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Shared references"}),": Same object referenced multiple times is serialized once"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Circular references"}),": Objects that reference themselves or form cycles"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Memory efficiency"}),": No duplicate data for repeated objects"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"\u542f\u7528\u5f15\u7528\u8ddf\u8e2a",children:"\u542f\u7528\u5f15\u7528\u8ddf\u8e2a"}),"\n",(0,i.jsx)(n.h3,{id:"java",children:"Java"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"Fory fory = Fory.builder()\n    .withLanguage(Language.XLANG)\n    .withRefTracking(true)\n    .build();\n"})}),"\n",(0,i.jsx)(n.h3,{id:"python",children:"Python"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"fory = pyfory.Fory(xlang=True, ref_tracking=True)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"go",children:"Go"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"fory := forygo.NewFory(true)  // true enables ref tracking\n"})}),"\n",(0,i.jsx)(n.h3,{id:"c",children:"C++"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:"auto fory = fory::Fory::create(fory::Config{\n    .ref_tracking = true\n});\n"})}),"\n",(0,i.jsx)(n.h3,{id:"rust",children:"Rust"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:"let fory = Fory::builder()\n    .with_ref_tracking(true)\n    .build();\n"})}),"\n",(0,i.jsx)(n.h2,{id:"\u7ebf\u683c\u5f0f",children:"\u7ebf\u683c\u5f0f"}),"\n",(0,i.jsxs)(n.p,{children:["When reference tracking is enabled, nullable fields write a ",(0,i.jsx)(n.strong,{children:"ref flag byte"})," before the value:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"[ref_flag] [value data if not null/ref]\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Where ",(0,i.jsx)(n.code,{children:"ref_flag"})," is:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Value"}),(0,i.jsx)(n.th,{children:"Meaning"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"-1"})," (NULL_FLAG)"]}),(0,i.jsx)(n.td,{children:"Value is null"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"-2"})," (NOT_NULL_VALUE_FLAG)"]}),(0,i.jsx)(n.td,{children:"Value is present, first occurrence"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"\u22650"})}),(0,i.jsx)(n.td,{children:"Reference ID pointing to previously serialized object"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"\u5f15\u7528\u8ddf\u8e2a\u4e0e\u53ef\u7a7a\u6027",children:"\u5f15\u7528\u8ddf\u8e2a\u4e0e\u53ef\u7a7a\u6027"}),"\n",(0,i.jsxs)(n.p,{children:["These are ",(0,i.jsx)(n.strong,{children:"independent"})," concepts:"]}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Concept"}),(0,i.jsx)(n.th,{children:"Purpose"}),(0,i.jsx)(n.th,{children:"Controlled By"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Nullability"})}),(0,i.jsx)(n.td,{children:"Whether a field can hold null values"}),(0,i.jsxs)(n.td,{children:["Field type (",(0,i.jsx)(n.code,{children:"Optional<T>"}),") or annotation"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"Reference Tracking"})}),(0,i.jsx)(n.td,{children:"Whether duplicate objects are deduplicated"}),(0,i.jsxs)(n.td,{children:["Global ",(0,i.jsx)(n.code,{children:"refTracking"})," option"]})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"Key behavior:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Ref flag bytes are ",(0,i.jsx)(n.strong,{children:"only written for nullable fields"})]}),"\n",(0,i.jsxs)(n.li,{children:["Non-nullable fields skip ref flags entirely, even with ",(0,i.jsx)(n.code,{children:"refTracking=true"})]}),"\n",(0,i.jsx)(n.li,{children:"Reference deduplication only applies to objects that appear multiple times"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"// Reference tracking enabled, but non-nullable fields still skip ref flags\nFory fory = Fory.builder()\n    .withLanguage(Language.XLANG)\n    .withRefTracking(true)\n    .build();\n"})}),"\n",(0,i.jsx)(n.h2,{id:"per-field-reference-tracking",children:"Per-Field Reference Tracking"}),"\n",(0,i.jsxs)(n.p,{children:["By default, ",(0,i.jsx)(n.strong,{children:"most fields do not track references"})," even when global ",(0,i.jsx)(n.code,{children:"refTracking=true"}),". Only specific pointer/smart pointer types track references by default."]}),"\n",(0,i.jsx)(n.h3,{id:"\u9ed8\u8ba4\u884c\u4e3a-by-language",children:"\u9ed8\u8ba4\u884c\u4e3a by Language"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Language"}),(0,i.jsx)(n.th,{children:"Default Ref Tracking"}),(0,i.jsx)(n.th,{children:"Types That Track Refs by Default"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Java"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:"None (use annotation to enable)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Python"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:"None (use annotation to enable)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Go"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsxs)(n.td,{children:["None (use ",(0,i.jsx)(n.code,{children:'fory:"ref"'})," to enable)"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"C++"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"std::shared_ptr<T>"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Rust"}),(0,i.jsx)(n.td,{children:"No"}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"Rc<T>"}),", ",(0,i.jsx)(n.code,{children:"Arc<T>"}),", ",(0,i.jsx)(n.code,{children:"Weak<T>"})]})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"customizing-per-field-ref-tracking",children:"Customizing Per-Field Ref Tracking"}),"\n",(0,i.jsx)(n.h4,{id:"java-foryfield-annotation",children:"Java: @ForyField Annotation"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class Document {\n    // Default: no ref tracking\n    String title;\n\n    // Enable ref tracking for this field\n    @ForyField(trackingRef = true)\n    Author author;\n\n    // Shared across documents, track refs to avoid duplicates\n    @ForyField(trackingRef = true)\n    List<Tag> tags;\n}\n"})}),"\n",(0,i.jsx)(n.h4,{id:"c-foryfield-wrapper",children:"C++: fory::field Wrapper"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-cpp",children:"struct Document {\n    std::string title;\n\n    // shared_ptr tracks refs by default\n    std::shared_ptr<Author> author;\n\n    // Explicitly enable ref tracking\n    fory::field<std::vector<Tag>, 1, fory::track_ref<true>> tags;\n\n    // Explicitly disable ref tracking\n    fory::field<std::shared_ptr<Data>, 2, fory::track_ref<false>> data;\n};\nFORY_STRUCT(Document, title, author, tags, data);\n"})}),"\n",(0,i.jsx)(n.h4,{id:"rust-field-attributes",children:"Rust: Field Attributes"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-rust",children:'#[derive(Fory)]\n#[tag("example.Document")]\nstruct Document {\n    title: String,\n\n    // Rc/Arc track refs by default\n    author: Rc<Author>,\n\n    // Explicitly enable ref tracking\n    #[track_ref]\n    tags: Vec<Tag>,\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"go-struct-tags",children:"Go: Struct Tags"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'type Document struct {\n    Title string\n\n    // Enable ref tracking for pointer to struct\n    Author *Author `fory:"ref"`\n\n    // Enable ref tracking for slice\n    Tags []Tag `fory:"ref"`\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"when-to-enable-per-field-ref-tracking",children:"When to Enable Per-Field Ref Tracking"}),"\n",(0,i.jsx)(n.p,{children:"Enable ref tracking for fields that:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"May contain the same object instance multiple times"}),"\n",(0,i.jsx)(n.li,{children:"Are part of circular reference chains"}),"\n",(0,i.jsx)(n.li,{children:"Hold large objects that might be shared"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Disable (or leave default) for fields that:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Always contain unique values"}),"\n",(0,i.jsx)(n.li,{children:"Are primitives or simple value types"}),"\n",(0,i.jsx)(n.li,{children:"Don't participate in object sharing"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"example-shared-references",children:"Example: Shared References"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public class Container {\n    List<String> data;\n    List<String> sameData;  // Points to same list\n}\n\nContainer obj = new Container();\nobj.data = Arrays.asList("a", "b", "c");\nobj.sameData = obj.data;  // Shared reference\n\n// With refTracking=true: data serialized once, sameData stores reference ID\n// With refTracking=false: data serialized twice (duplicate)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"example-circular-references",children:"Example: Circular References"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public class Node {\n    String value;\n    Node next;\n}\n\nNode a = new Node("A");\nNode b = new Node("B");\na.next = b;\nb.next = a;  // Circular reference\n\n// With refTracking=true: works correctly\n// With refTracking=false: infinite recursion error\n'})}),"\n",(0,i.jsx)(n.h2,{id:"language-support",children:"Language Support"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Language"}),(0,i.jsx)(n.th,{children:"Shared Refs"}),(0,i.jsx)(n.th,{children:"Circular Refs"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Java"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Python"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Go"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"C++"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"JavaScript"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"Yes"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Rust"}),(0,i.jsx)(n.td,{children:"Yes"}),(0,i.jsx)(n.td,{children:"No (ownership rules)"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Overhead"}),": Reference tracking adds a hash map lookup per object"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"When to enable"}),": Use when data has shared/circular references"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"When to disable"}),": Use for simple data structures without sharing"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/zh-CN/docs/guide/xlang/field_nullability",children:"Field Nullability"})," - How nullability affects serialization"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/zh-CN/docs/guide/xlang/xlang_serialization",children:"Serialization"})," - Basic cross-language serialization examples"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://fory.apache.org/docs/specification/fory_xlang_serialization_spec",children:"Xlang Specification"})," - Binary protocol details"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},11151:(e,n,r)=>{r.d(n,{Z:()=>a,a:()=>l});var i=r(67294);const s={},t=i.createContext(s);function l(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);